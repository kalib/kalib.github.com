
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Marcelo Cavalcante Rocha ~</title>
  <meta name="author" content="Marcelo Cavalcante Rocha - Kalib">

  
  <meta name="description" content="Pare e volte uma casa Se você nunca utilizou ou sabe pouco sobre o Chef é importante que você pare aqui mesmo e volte uma casa. Sugiro que leia o &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://kalib.github.io/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Marcelo Cavalcante Rocha ~" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-42903485-1']);
    _gaq.push(['_setDomainName','marcelocavalcante.net']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:kalib.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
    <li><a href="/">
        <span class="blue_light">
            Marcelo Cavalcante Rocha ~
        </span>
       
           <span class="blue_dark">
             Hacking the damn life...
           </span>
       
    </a></li>
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Arquivos</a></li>
  <li><a href="/about">Sobre mim</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/04/14/chef-uso-de-condicionais-not-if-e-only-if/">Chef: Uso De Condicionais Not_if E Only_if</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2018-04-14T19:33:00-04:00" pubdate data-updated="true">Apr 14<span>th</span>, 2018</time>
        
         | <a href="/blog/2018/04/14/chef-uso-de-condicionais-not-if-e-only-if/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img class="center" src="/imgs/chef-logo2.png" title="'Chef'" ></p>

<h2>Pare e volte uma casa</h2>

<p><img class="center" src="/imgs/volte1casa.jpeg" title="'Volte1Casa'" >
<strong>S</strong>e você nunca utilizou ou sabe pouco sobre o <em>Chef</em> é importante que você pare aqui mesmo e volte uma casa. Sugiro que leia o post <a href="http://blog.marcelocavalcante.net/blog/2018/04/01/chef-aautomacao-e-gerenciamento-de-configuracao/">Chef: Automação e Gerenciamento de Configuração</a> antes de seguir este, uma vez que através dele você entenderá o que é, e como funciona o Chef, bem como sua instalação básica.</p>

<h2>Resources</h2>

<p><strong>C</strong>onforme dito no post anterior, resource é uma descrição de estado que:</p>

<ul>
<li>Descreve o estado desejado para um item de configuração</li>
<li>Declara os passos necessários para levar o item especificado ao estado desejado</li>
<li>Especifica o tipo de resource &ndash; por exemplo, <code>package</code>, <code>template</code> ou <code>service</code></li>
<li>Lita detalhes adicionais (também conhecidos como propriedades de resources), conforme necessário</li>
<li>São agrupados em <em>recipes</em>, que descrevem configurações em geral</li>
</ul>


<h2>Utilizando (Guardas) not_if e only_if</h2>

<p><strong>T</strong>odos os resources (incluindo os personalizados) no Chef compartilham um conjunto de opções comuns: ações, propriedades, condicionais, notificações e paths relativos.</p>

<p><strong>Guards</strong></p>

<p><strong>P</strong>ropriedades de <em>guarda</em>, ou <code>guards</code>, como são chamadas no Chef, podem ser utilizadas para avaliar o estado de um node durante a fase de execução do chef-client. Esta avaliação funciona como uma condicional e, baseando-se nos resultados da mesma, a propriedade guard é então utilizada para indicar ao chef-client se ele deve ou não continuar a execução de um resource. Uma propriedade guard aceita tanto um valor string quanto um bloco de código Ruby.</p>

<ul>
<li>A string é executada como um comando shell. Caso o comando retorne <code>0</code> (true), a propriedade guard é aplicada. Caso o comando retorne qualquer outro valor a propriedade guard não será aplicada.</li>
<li>Um bloco é executado como um código Ruby que deve retornar <code>true</code> ou <code>false</code>. Da mesma forma, caso o comando retorne <code>true</code>, a propriedade guard é aplicada. Caso o comando retorne <code>false</code> a propriedade guard não será aplicada.</li>
</ul>


<p><strong>U</strong>ma <strong>guard</strong> é importante para garantir que um resource seja idempotente ao permitir um teste no próprio resource certificando-se de que o mesmo se encontra no estado desejado de forma que o chef-client não faça nada.</p>

<p><strong>Atributos</strong></p>

<p><strong>O</strong>s seguintes atributos podem ser utilizados para definir uma guard que é avaliada durante a fase de execução do chef-client:</p>

<p><code>not_if</code> &ndash; <strong>Impede</strong> a execução de um resource quando a condição retornar <code>true</code>.</p>

<p><code>only_if</code> &ndash; Permite a execução de um resource <strong>apenas</strong> quando a condição retornar <code>true</code>.</p>

<h2>Mãos à obra</h2>

<p><strong>P</strong>ara simplificar seguirei utilizando a recipe utilizada no post anterior. Não sabe o que é uma recipe? <code>-&gt;</code> Novamente, caso não entenda o que estou dizendo, volte uma casa e leia o <a href="http://blog.marcelocavalcante.net/blog/2018/04/01/chef-aautomacao-e-gerenciamento-de-configuracao/">post anterior</a>, no qual explico o que é uma recipe, bem como cada elemento da mesma, visto que a utilizaremos aqui.</p>

<p><strong>N</strong>ossa recipe era a seguinte:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>package 'apache' do
</span><span class='line'>        package_name 'httpd'
</span><span class='line'>        action :install
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>service 'httpd' do
</span><span class='line'>        action [:enable, :start]
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>file '/var/www/html/index.html' do
</span><span class='line'>        content 'Hello World!'
</span><span class='line'>        mode '0755'
</span><span class='line'>        owner 'root'
</span><span class='line'>        group 'apache'
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p><strong>C</strong>omo primeira alteração vamos editar o arquivo <code>/etc/motd</code>. Este arquivo nada mais é do que a definição de um baner que será apresentado sempre que alguém se logar em seu servidor.</p>

<p><strong>P</strong>or padrão, este arquivo costuma vir vazio. Este é o caso da máquina utilizada para este exemplo:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@kalib6 ~]# cat /etc/motd
</span><span class='line'>[root@kalib6 ~]#</span></code></pre></td></tr></table></div></figure>


<p><strong>C</strong>omeçaremos definindo o conteúdo que deverá existir em nosso arquivo <code>/etc/motd</code> incluindo um resource do tipo <code>file</code> no final de nossa recipe <code>exemplo.rb</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>package 'apache' do
</span><span class='line'>        package_name 'httpd'
</span><span class='line'>        action :install
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>service 'httpd' do
</span><span class='line'>        action [:enable, :start]
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>file '/var/www/html/index.html' do
</span><span class='line'>        content 'Hello World!'
</span><span class='line'>        mode '0755'
</span><span class='line'>        owner 'root'
</span><span class='line'>        group 'apache'
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>file '/etc/motd' do
</span><span class='line'>        content 'Bem Vindo!'
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p><strong>A</strong>té aqui nenhuma novidade (caso você tenha lido de fato o post anterior ou já tenha utilizado Chef anteriormente), apenas incluímos mais um resource em nossa recipe <code>exemplo.rb</code> informando que o arquivo <code>/etc/motd</code> deve existir e que seu conteúdo deverá ser <em>Bem Vindo!</em>.</p>

<p><strong>V</strong>alidando e executando localmente nossa recipe conforme feito anteriormente veremos que todos os demais passos ou resources serão ignorados por já estarem estarem no estado desejado (idempotência), restando apenas a inclusão do conteúdo no <code>/etc/motd</code>:</p>

<p><strong>Validando</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@kalib6 ~]# ruby -c exemplo.rb && foodcritic exemplo.rb
</span><span class='line'>Syntax OK
</span><span class='line'>Checking 1 files
</span><span class='line'>x
</span><span class='line'>FC011: Missing README in markdown format: ../README.md:1
</span><span class='line'>FC031: Cookbook without metadata.rb file: ../metadata.rb:1
</span><span class='line'>FC071: Missing LICENSE file: ../LICENSE:1</span></code></pre></td></tr></table></div></figure>


<p><strong>Executando</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@kalib6 ~]# chef-client --local-mode exemplo.rb
</span><span class='line'>[2018-04-15T22:03:26+00:00] WARN: No config file found or specified on command line, using command line options.
</span><span class='line'>[2018-04-15T22:03:26+00:00] WARN: No cookbooks directory found at or above current directory.  Assuming /root.
</span><span class='line'>Starting Chef Client, version 13.8.5
</span><span class='line'>resolving cookbooks for run list: []
</span><span class='line'>Synchronizing Cookbooks:
</span><span class='line'>Installing Cookbook Gems:
</span><span class='line'>Compiling Cookbooks...
</span><span class='line'>[2018-04-15T22:03:29+00:00] WARN: Node kalib6.test.com has an empty run list.
</span><span class='line'>Converging 4 resources
</span><span class='line'>Recipe: @recipe_files::/root/exemplo.rb
</span><span class='line'>  * yum_package[apache] action install (up to date)
</span><span class='line'>  * service[httpd] action enable (up to date)
</span><span class='line'>  * service[httpd] action start (up to date)
</span><span class='line'>  * file[/var/www/html/index.html] action create (up to date)
</span><span class='line'>  * file[/etc/motd] action create
</span><span class='line'>    - update content in file /etc/motd from e3b0c4 to f13843
</span><span class='line'>    --- /etc/motd       2018-04-15 20:51:00.411479476 +0000
</span><span class='line'>    +++ /etc/.chef-motd20180415-1681-1p1fm7m    2018-04-15 22:03:42.142091791 +0000
</span><span class='line'>    @@ -1 +1,2 @@
</span><span class='line'>    +Bem Vindo!
</span><span class='line'>    - restore selinux security context
</span><span class='line'>
</span><span class='line'>Running handlers:
</span><span class='line'>Running handlers complete
</span><span class='line'>Chef Client finished, 1/5 resources updated in 15 seconds</span></code></pre></td></tr></table></div></figure>


<p><strong>P</strong>ara termos certeza de que o nosso arquivo foi corretamente alterado&hellip;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@kalib6 ~]# cat /etc/motd
</span><span class='line'>Bem Vindo!</span></code></pre></td></tr></table></div></figure>


<p><strong>N</strong>ovamente, nenhuma novidade até aqui.</p>

<p><strong>V</strong>amos agora utilizar o tipo de resource <code>execute</code>, o qual nos permite executar um comando a cada execução do chef-client. Vale lembrar que uma das características do Chef é a idempotência, portanto o <code>execute</code> pode ser considerado uma exceção, já que o comando será executado sempre, mesmo que já tenha sido executado anteriormente. E é neste tipo de situação que os <code>guards</code> se mostram importantes.</p>

<p><strong>C</strong>omecemos inserindo um resource do tipo <code>execute</code> em nossa recipe:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>package 'apache' do
</span><span class='line'>        package_name 'httpd'
</span><span class='line'>        action :install
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>service 'httpd' do
</span><span class='line'>        action [:enable, :start]
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>file '/var/www/html/index.html' do
</span><span class='line'>        content 'Hello World!'
</span><span class='line'>        mode '0755'
</span><span class='line'>        owner 'root'
</span><span class='line'>        group 'apache'
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>file '/etc/motd' do
</span><span class='line'>        content 'Bem Vindo!'
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>execute 'meu-comando' do
</span><span class='line'>        command 'echo " Obrigado!" &gt;&gt; /etc/motd'
</span><span class='line'>        only_if 'test -r /etc/motd'
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p><strong>O</strong> que adicionamos aqui?</p>

<ul>
<li>Resource Type: execute (Para que possamos executar um comando)</li>
<li>Resource Name: meu-comando (Poderíamos ter utilizado qualquer nome)</li>
<li>Command: &lsquo;echo &ldquo; Obrigado!&rdquo; >> /etc/motd&rsquo; (O comando que desejamos executar. Estou utilizando <code>echo</code> para inserir * Obrigado!* ao meu arquivo <code>/etc/motd</code>)</li>
<li>Guard: only_if &lsquo;test -r /etc/motd&rsquo; (<code>only_if</code> implica que meu resource <em>meu-comando</em> será executado <strong>apenas</strong> caso o resultado de <code>test -r /etc/motd</code> seja positivo. <em>test -r</em> irá verificar se o arquivo <code>/etc/motd</code> existe no sistema. Caso sim, meu comando <code>echo " Obrigado!" &gt;&gt; /etc/motd</code> será executado conforme planejado, do contrário será ignorado)</li>
</ul>


<p><strong>N</strong>ós já sabemos que o arquivo existe, portanto esperamos que * Obrigado!* seja adicionada ao mesmo após execução do chef-client.</p>

<p><strong>Verificando nosso código</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@kalib6 ~]# ruby -c exemplo.rb && foodcritic exemplo.rb
</span><span class='line'>Syntax OK
</span><span class='line'>Checking 1 files
</span><span class='line'>x
</span><span class='line'>FC011: Missing README in markdown format: ../README.md:1
</span><span class='line'>FC031: Cookbook without metadata.rb file: ../metadata.rb:1
</span><span class='line'>FC071: Missing LICENSE file: ../LICENSE:1</span></code></pre></td></tr></table></div></figure>


<p><strong>Tudo ok. Executando&hellip;</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@kalib6 ~]# chef-client --local-mode exemplo.rb
</span><span class='line'>[2018-04-15T23:08:54+00:00] WARN: No config file found or specified on command line, using command line options.
</span><span class='line'>[2018-04-15T23:08:54+00:00] WARN: No cookbooks directory found at or above current directory.  Assuming /root.
</span><span class='line'>Starting Chef Client, version 13.8.5
</span><span class='line'>resolving cookbooks for run list: []
</span><span class='line'>Synchronizing Cookbooks:
</span><span class='line'>Installing Cookbook Gems:
</span><span class='line'>Compiling Cookbooks...
</span><span class='line'>[2018-04-15T23:09:03+00:00] WARN: Node kalib6.test.com has an empty run list.
</span><span class='line'>Converging 5 resources
</span><span class='line'>Recipe: @recipe_files::/root/exemplo.rb
</span><span class='line'>  * yum_package[apache] action install (up to date)
</span><span class='line'>  * service[httpd] action enable (up to date)
</span><span class='line'>  * service[httpd] action start (up to date)
</span><span class='line'>  * file[/var/www/html/index.html] action create (up to date)
</span><span class='line'>  * file[/etc/motd] action create (up to date)
</span><span class='line'>  * execute[meu-comando] action run
</span><span class='line'>    - execute echo " Obrigado!" &gt;&gt; /etc/motd
</span><span class='line'>
</span><span class='line'>Running handlers:
</span><span class='line'>Running handlers complete
</span><span class='line'>Chef Client finished, 1/6 resources updated in 31 seconds</span></code></pre></td></tr></table></div></figure>


<p><strong>R</strong>epare que o Chef executou o comando para inserir <code>Obrigado!</code>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@kalib6 ~]# cat /etc/motd
</span><span class='line'>Bem Vindo! Obrigado!</span></code></pre></td></tr></table></div></figure>


<p><strong>C</strong>onforme dito anteriormente, o resource <code>execute</code> irá executar o meu comando SEMPRE que o chef-client rodar. Vejamos o que acontece ao executar novamente o chef-client sem alterar a recipe.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@kalib6 ~]# chef-client --local-mode exemplo.rb
</span><span class='line'>[2018-04-15T23:18:10+00:00] WARN: No config file found or specified on command line, using command line options.
</span><span class='line'>[2018-04-15T23:18:10+00:00] WARN: No cookbooks directory found at or above current directory.  Assuming /root.
</span><span class='line'>Starting Chef Client, version 13.8.5
</span><span class='line'>resolving cookbooks for run list: []
</span><span class='line'>Synchronizing Cookbooks:
</span><span class='line'>Installing Cookbook Gems:
</span><span class='line'>Compiling Cookbooks...
</span><span class='line'>[2018-04-15T23:18:20+00:00] WARN: Node kalib6.test.com has an empty run list.
</span><span class='line'>Converging 5 resources
</span><span class='line'>Recipe: @recipe_files::/root/exemplo.rb
</span><span class='line'>  * yum_package[apache] action install (up to date)
</span><span class='line'>  * service[httpd] action enable (up to date)
</span><span class='line'>  * service[httpd] action start (up to date)
</span><span class='line'>  * file[/var/www/html/index.html] action create (up to date)
</span><span class='line'>  * file[/etc/motd] action create
</span><span class='line'>    - update content in file /etc/motd from 201ddf to f13843
</span><span class='line'>    --- /etc/motd       2018-04-15 23:16:13.705005377 +0000
</span><span class='line'>    +++ /etc/.chef-motd20180415-2432-zhtjnq     2018-04-15 23:18:42.138379629 +0000
</span><span class='line'>    @@ -1,2 +1,2 @@
</span><span class='line'>    -Bem Vindo! Obrigado!
</span><span class='line'>    +Bem Vindo!
</span><span class='line'>    - restore selinux security context
</span><span class='line'>  * execute[meu-comando] action run
</span><span class='line'>    - execute echo " Obrigado!" &gt;&gt; /etc/motd
</span><span class='line'>
</span><span class='line'>Running handlers:
</span><span class='line'>Running handlers complete
</span><span class='line'>Chef Client finished, 2/6 resources updated in 31 seconds</span></code></pre></td></tr></table></div></figure>


<p><strong>C</strong>omo em nossa recipe temos o resource <code>file</code> que determina o conteúdo do arquivo <code>/etc/motd</code> como sendo <code>Bem Vindo!</code>, o chef percebeu que o arquivo se encontrava diferente, pois acrescentamos o <code>Obrigado!</code> no passo anterior. O arquivo foi corrigido, voltando a ter seu conteúdo original, em seguida o Chef inseriu novamente <code>Obrigado!</code>, pois assim está determinado em nossa recipe.</p>

<p><strong>É</strong> fácil perceber isto nas linhas a seguir, retiradas do resultado de nossa última execução do chef-client:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>* file[/etc/motd] action create
</span><span class='line'>  - update content in file /etc/motd from 201ddf to f13843
</span><span class='line'>  --- /etc/motd       2018-04-15 23:16:13.705005377 +0000
</span><span class='line'>  +++ /etc/.chef-motd20180415-2432-zhtjnq     2018-04-15 23:18:42.138379629 +0000
</span><span class='line'>  @@ -1,2 +1,2 @@
</span><span class='line'>  -Bem Vindo! Obrigado!
</span><span class='line'>  +Bem Vindo!
</span><span class='line'>  - restore selinux security context
</span><span class='line'>* execute[meu-comando] action run
</span><span class='line'>  - execute echo " Obrigado!" &gt;&gt; /etc/motd</span></code></pre></td></tr></table></div></figure>


<p><strong>S</strong>e verificarmos nosso arquivo, veremos que ele está da mesma forma:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@kalib6 ~]# cat /etc/motd
</span><span class='line'>Bem Vindo! Obrigado!</span></code></pre></td></tr></table></div></figure>


<p><strong>P</strong>ara percebermos a diferença, vamos comentar as linhas do resource file <code>/etc/motd</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>...
</span><span class='line'>#file '/etc/motd' do
</span><span class='line'>#       content 'Bem Vindo!'
</span><span class='line'>#end
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<p><strong>A</strong>o comentar estas linhas, nossa recipe não mais indicará que o conteúdo do arquivo <code>/etc/motd</code> deve ser <code>Bem Vindo!</code>, portanto vejamos o que acontece quando executamos novamente o chef-client.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@kalib6 ~]# chef-client --local-mode exemplo.rb
</span><span class='line'>[2018-04-15T23:28:32+00:00] WARN: No config file found or specified on command line, using command line options.
</span><span class='line'>[2018-04-15T23:28:33+00:00] WARN: No cookbooks directory found at or above current directory.  Assuming /root.
</span><span class='line'>Starting Chef Client, version 13.8.5
</span><span class='line'>resolving cookbooks for run list: []
</span><span class='line'>Synchronizing Cookbooks:
</span><span class='line'>Installing Cookbook Gems:
</span><span class='line'>Compiling Cookbooks...
</span><span class='line'>[2018-04-15T23:28:42+00:00] WARN: Node kalib6.test.com has an empty run list.
</span><span class='line'>Converging 4 resources
</span><span class='line'>Recipe: @recipe_files::/root/exemplo.rb
</span><span class='line'>  * yum_package[apache] action install (up to date)
</span><span class='line'>  * service[httpd] action enable (up to date)
</span><span class='line'>  * service[httpd] action start (up to date)
</span><span class='line'>  * file[/var/www/html/index.html] action create (up to date)
</span><span class='line'>  * execute[meu-comando] action run
</span><span class='line'>    - execute echo " Obrigado!" &gt;&gt; /etc/motd
</span><span class='line'>
</span><span class='line'>Running handlers:
</span><span class='line'>Running handlers complete
</span><span class='line'>Chef Client finished, 1/5 resources updated in 32 seconds</span></code></pre></td></tr></table></div></figure>


<p><strong>U</strong>ma vez que nosso arquivo <code>/etc/motd</code> já possuía o conteúdo <code>Bem Vindo! Obrigado!</code> e desta vez não tentou garantir que o conteúdo do mesmo fosse apenas <code>Bem Vindo!</code>, vejamos como ele se encontra:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@kalib6 ~]# cat /etc/motd
</span><span class='line'>Bem Vindo! Obrigado!
</span><span class='line'> Obrigado!
</span><span class='line'> ```
</span><span class='line'>
</span><span class='line'> **C**omo esperado, inserimos mais um ` Obrigado!` ao arquivo. Se executarmos novamente o chef-client, estaremos acrescentando novamente um ` Obrigado!` ao arquivo, pois o mesmo existe e não estamos mais tentando validar seu conteúdo.
</span><span class='line'>
</span><span class='line'> **E** se removermos manualmente o arquivo `/etc/motd`?
</span><span class='line'>
</span><span class='line'> ```
</span><span class='line'>[root@kalib6 ~]# rm /etc/motd
</span><span class='line'>rm: remove regular file ‘/etc/motd’? y
</span><span class='line'>[root@kalib6 ~]# cat /etc/motd
</span><span class='line'>cat: /etc/motd: No such file or directory</span></code></pre></td></tr></table></div></figure>


<p><strong>V</strong>ejamos o que o chef-client fará:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>... (Ignorando linhas desnecessárias)
</span><span class='line'>  * execute[meu-comando] action run (skipped due to only_if)
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<p><strong>C</strong>omo já tínhamos comentado as linhas que garantem que o <code>/etc/motd</code> existe e possui o conteúdo <code>Bem Vindo!</code>, o resource que incluiría <code>Obrigado!</code> foi ignorado, pois em nossa guard temos a condição <code>only_if</code>, que indica que o comando só será executado SE o arquivo /etc/motd existir. Para ter certeza disto, vamos verificar:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@kalib6 ~]# cat /etc/motd
</span><span class='line'>cat: /etc/motd: No such file or directory</span></code></pre></td></tr></table></div></figure>


<p><strong>A</strong>proveitando a situação, vamos alterar nossa recipe e utilizar <code>not_if</code> ao invés de <code>only_if</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>package 'apache' do
</span><span class='line'>        package_name 'httpd'
</span><span class='line'>        action :install
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>service 'httpd' do
</span><span class='line'>        action [:enable, :start]
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>file '/var/www/html/index.html' do
</span><span class='line'>        content 'Hello World!'
</span><span class='line'>        mode '0755'
</span><span class='line'>        owner 'root'
</span><span class='line'>        group 'apache'
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>#file '/etc/motd' do
</span><span class='line'>#       content 'Bem Vindo!'
</span><span class='line'>#end
</span><span class='line'>
</span><span class='line'>execute 'meu-comando' do
</span><span class='line'>        command 'echo " Obrigado!" &gt;&gt; /etc/motd'
</span><span class='line'>        not_if 'test -r /etc/motd'
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p><strong>J</strong>á sabemos que o arquivo não existe, portanto a nossa regra agora será satisfeita, visto que queremos adicionar o conteúdo <code>Obrigado!</code> APENAS caso o arquivo NÃO exista.</p>

<p><strong>V</strong>ale lembrar que, por padrão, o comando <code>echo ' Obrigado!' &gt;&gt; /etc/motd</code> irá adicionar o conteúdo ao arquivo e, caso o mesmo não exista, ele será criado com o determinado conteúdo. Isto não é um recurso do Chef, mas sim do próprio linux/echo. Executando nosso chef-client:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>... (Ignorando linhas desnecessárias)
</span><span class='line'>* execute[meu-comando] action run
</span><span class='line'>  - execute echo " Obrigado!" &gt;&gt; /etc/motd
</span><span class='line'>
</span><span class='line'>Running handlers:
</span><span class='line'>Running handlers complete</span></code></pre></td></tr></table></div></figure>


<p><strong>R</strong>epare que o arquivo foi criado apenas com o conteúdo <code>Obrigado!</code>, conforme descrito em nossa recipe.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@kalib6 ~]# cat /etc/motd
</span><span class='line'> Obrigado!</span></code></pre></td></tr></table></div></figure>


<p><strong>C</strong>aso o chef-client seja executado novamente, nada acontecerá, uma vez que o resource atual indica que o comando APENAS deverá ser executado caso o arquivo NÃO exista.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>... (Ignorando linhas desnecessárias)
</span><span class='line'>  * execute[meu-comando] action run (skipped due to not_if)
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<p><strong>S</strong>imples, certo?! É importante lembrar que o Chef executará os resources na devida ordem em que forem listados na recipe, portanto é importante alinhar todas as instruções e resources de acordo com o resultado desejado.</p>

<p><strong>H</strong>appy hacking!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/04/01/chef-aautomacao-e-gerenciamento-de-configuracao/">Chef: Automação E Gerenciamento De Configuração</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2018-04-01T11:22:00-04:00" pubdate data-updated="true">Apr 1<span>st</span>, 2018</time>
        
         | <a href="/blog/2018/04/01/chef-aautomacao-e-gerenciamento-de-configuracao/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img class="center" src="/imgs/cheflogo.png" title="'Chef'" ></p>

<h2>Uma coisa de cada vez</h2>

<p><strong>C</strong>hef é uma popular ferramenta de Gerenciamento de Configurações criado pela empresa de mesmo nome, Chef. O <a href="https://www.chef.io">Chef</a> é desenvolvido em <a href="http://www.ruby-lang.org">Ruby</a> e <a href="https://www.erlang.org">Erlang</a>, e utiliza uma linguagem DSL (domain-specific language) em Ruby puro para escrever arquivos de configuração de sistemas chamados &ldquo;recipes&rdquo; (receitas).</p>

<p><strong>A</strong>ntes de falarmos sobre o Chef é importante entender primeiramente o conceito e a utilidade de ferramentas de Gerenciamento de Configuração.</p>

<h2>Gerenciamento de Configuração</h2>

<p><strong>G</strong>erenciamento de Configuração, ou CM (Configuration Management), é um processo de engenharia de sistemas que visa garantir a consistência entre ativos físicos e lógicos em um ambiente operacional. O processo de gerenciamento de configuração busca identificar e rastrear itens individuais de configuração, documentando capacidades funcionais e interdependências. Administradores, técnicos e desenvolvedores de sistemas podem utilizar ferramentas de Gerenciamento de Configuração para verificar o efeito que uma mudança em um item de configuração terá em outros sistemas.</p>

<p><strong>E</strong>m palavras simples, o objetivo de uma ferramenta de gerenciamento de configuração é simplificar a vida de quem administra serviços e sistemas garantindo uma uniformidade no quesito configuração.</p>

<p><strong>C</strong>omo exemplo prático e simplista, imagine um servidor web que será responsável por hospedar um pequeno site em php. Este servidor possuirá alguns atributos/aplicativos/configurações, tais como:</p>

<ul>
<li>Apache instalado;</li>
<li>Alterações específicas nos arquivos de configuração do Apache;</li>
<li>Serviço do Apache ativo e iniciado;</li>
<li>Arquivos referentes ao site em si em um diretório específico;</li>
<li>Permissões específicas atribuídas ao diretório específico do site;</li>
<li>etc&hellip;</li>
</ul>


<p><strong>C</strong>onfigurar tudo isso manualmente em um único servidor é simples. Você poderia conectar-se via SSH no servidor, instalar o apache com o gerenciador de pacotes da distribuição utilizada, configurar o que for necessário no apache, iniciar o serviço, etc, etc, etc. Mas o que fazer quando sua infraestrutura cresce? Quando se quer maior disponibilidade do site, quando agora você roda este site em um cluster com 5 servidores?</p>

<p><strong>B</strong>asicamente a mesma coisa, certo? Você pode se conectar em cada um dos servidores e repetir os mesmos passos. O problema se dá justamente nessa repetição de passos, onde você pode cometer erros, perder tempo, etc. Além disso, o que acontece se um colega seu modificar algo em um dos servidores e não lhe avisar? E se ele esquecer de replicar esta mudança nos demais?</p>

<p><strong>É</strong> fácil achar diversas razões pelas quais torna-se difícil administrar e gerenciar configurações em ambientes mais complexos. A ideia por trás de uma ferramenta de Gerenciamento de Configuração é justamente reduzir esta complexidade, eliminando a necessidade de conectar-se manualmente à diversos servidores para aplicar as mesmas rotinas, passos e configurações.</p>

<p><strong>A</strong>través de arquivos de texto podemos literalmente descrever o estado e as ações desejadas para nossos serviços e sistemas. Por exemplo: Posso dizer que possuo um grupo de servidores chamado WebServer, o qual contém 10 servidores com o Sistema Operacional CentOS 7. Posso incluir a informação de que preciso que todos eles estejam com a versão X do Apache instalada e que o serviço esteja ativo e rodando. Além disso, posso dizer que desejo que exista no diretório /var/www/meusite/ todo o conteúdo que está em um mapeamento de rede específico, ou mesmo em um repositório que possuo no github.</p>

<p><strong>A</strong>o invés de me conectar em cada um dos 10 servidores para fazer tudo isso, um simples comando será o suficiente. O comando em específico dependerá da solução adotada, visto que existem diversas ferramentas de CM (Gerenciamento de Configuração). Mas, basicamente, ele irá ler o(s) arquivo(s) de &ldquo;instruções&rdquo; que nós definimos e saberá em quais servidores ele deverá instalar o Apache e configurar de acordo com o especificado, nos dando apenas o resultado final em forma de relatório simples.</p>

<p><strong>E</strong> se alguém da equipe alterar um arquivo de configuração diretamente em um dos servidores? A ferramenta, em sua próxima execucação, irá identificar que o estado desejado para aquele meu grupo de servidores está diferente em um dos servidores. Ela então modificará aquele arquivo específico naquele servidor para que ele volte ao seu estado desejado.</p>

<p><strong>A</strong>lém desta segurança, nós agora passamos a ter um ponto único de modificação. Ao desejarmos mudar algo, o faremos apenas no nosso &ldquo;código&rdquo;, ao invés de o fazer nos 10 servidores manualmente.</p>

<p><strong>O</strong> mesmo benefício se dá em caso de erros e falhas: um ponto único de correção.</p>

<p><strong>C</strong>om este mecanismo de descrever o estado de nossa infraestrutura em arquivos de texto/código, entramos em um novo conceito: Infrastructure as Code, ou Infraestrutura como Código. Uma vez que temos nossa infraestrutura em formato de código, podemos literalmente versionar e gerenciar nossa infraestrutura com repositórios Git, por exemplo.</p>

<h2>O que é Chef?</h2>

<p><strong>C</strong>onforme dito mais acima, Chef é uma das mais populares ferramentas de Gerenciamento de Configuração disponíveis atualmente. É compatível e facilmente integrado à plataformas de computação em nuvem, tais como Internap, Amazon EC2, Google Cloud Platform, OpenStack, SoftLayer, Microsoft Azure e Rackspace, provendo e configurando servidores automaticamente.</p>

<p><strong>O</strong> usuário escreve &ldquo;recipes&rdquo; (receitas) que descrevem como o Chef deve gerenciar aplicações, servidores e utilitários. Estas &ldquo;recipes&rdquo;, as quais podem ser agrupadas em &ldquo;cookbooks&rdquo; (livros de receitas) descrevem uma série de recursos que devem estar em um determinado estado. Este recursos podem ser pacotes, serviços ou mesmo arquivos.</p>

<p><strong>C</strong>hef pode rodar em um modo cliente/servidor ou standalone, com o chamado &ldquo;chef-solo&rdquo;. No modo cliente/servidor, o cliente Chef envia uma série de atributos sobre o node ou cliente/host para o Chef server. O Chef server utiliza-se da ferramenta <a href="https://lucene.apache.org/solr">Solr</a> para indexar estes atributos e provê uma API na qual os clientes podem fazer consultas. As recipes podem fazer requisições à esta base de atributos e utilizar os dados resultantes para configurar o cliente ou node.</p>

<p><strong>E</strong>mbora inicialmente o Chef fosse utilizado para gerenciar exclusivamente máquinas Linux, as versões mais atuais também suportam máquinas Windows.</p>

<p><strong>A</strong> ideia para este post é dar uma breve introdução ao Chef, portanto não vou entrar em maiores detalhes do funcionamento por hora.</p>

<h3>Resources</h3>

<p><strong>C</strong>omo dito antes, um Resource é uma descrição de estado desejado para um determinado item. Estes resources são gerenciados através de recipes.</p>

<p><strong>U</strong>m resource possui basicamente 4 componentes fundamentais que são definidos em um bloco de código Ruby:</p>

<ul>
<li>Resource Type &ndash; Tipo de resource (Pode ser um pacote, serviço, arquivo&hellip;)</li>
<li>Resource Name &ndash; Nome do resource</li>
<li>Resource Properties &ndash; Propriedades do resource</li>
<li>Actions &ndash; Ações a serem aplicadas ao resource</li>
</ul>


<p><strong>U</strong>m exemplo de recipe para instalar o Apache em um servidor Ubuntu, por exemplo, seria o seguinte:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>package 'httpd' do
</span><span class='line'>    action :install
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>No exemplo acima temos o tipo de resource como sendo &ldquo;package&rdquo;, o nome do resource como sendo &ldquo;httpd&rdquo; e a ação &ldquo;install&rdquo;.</p>

<p><strong>O</strong> que vai acontecer aqui? Simples de entender, certo? O pacote httpd (Apache) será instalado. Mas o que acontece caso o pacote httpd já esteja instalado?</p>

<p><strong>N</strong>ada. Uma das características do Chef é a <strong>idempotência</strong>. Na matemática e ciência da computação, a idempotência é a propriedade que algumas operações têm de poderem ser aplicadas várias vezes sem que o valor do resultado se altere após a aplicação inicial. Ou seja, O Chef primeiramente confere se o estado desejado já está aplicado e, caso sim, ignora aquela instrução.</p>

<p><strong>N</strong>ovamente&hellip; A ideia para este post é dar uma breve introdução ao Chef, portanto não vou entrar em maiores detalhes sobre os tipos de resources e suas possíveis ações. Vamos ao que interessa&hellip;</p>

<h2>Instalando o Chef</h2>

<p><strong>C</strong>onforme explicado acima, o Chef pode ser utilizado em modo cliente/servidor ou standalone. Para esta introdução utilizaremos o modo standalone ou local para simplificar as coisas.</p>

<p><strong>P</strong>ara instalar podemos utilizar o gerenciador de pacotes da distribuição Linux que utilizamos ou baixando o chefdk (Development Kit) através da página de <a href="https://downloads.chef.io/chefdk">downloads do chef</a>.</p>

<h3>Arch Linux</h3>

<p><strong>N</strong>o meu caso, utilizarei o pacote <a href="https://aur.archlinux.org/packages/chef-dk/">chef-dk</a> existente para o Arch Linux, mas sinta-se livre para baixar diretamente no site e executar o pacote de acordo com sua distribuição.</p>

<p><strong>1- Baixar o pacote do AUR:</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ wget https://aur.archlinux.org/cgit/aur.git/snapshot/chef-dk.tar.gz</span></code></pre></td></tr></table></div></figure>


<p><strong>2- Descompactar e Compilar:</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ tar -xvzf chef-dk.tar.gz
</span><span class='line'>
</span><span class='line'>$ cd chef-dk
</span><span class='line'>
</span><span class='line'>$ makepkg</span></code></pre></td></tr></table></div></figure>


<p><strong>3- Instalar o pacote:</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo pacman -U chef-dk-2.5.3-1-x86_64.pkg.tar.xz</span></code></pre></td></tr></table></div></figure>


<p><strong>4- Confirmar que deu tudo certo:</strong>*</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ chef --version
</span><span class='line'>
</span><span class='line'>Chef Development Kit Version: 2.5.3
</span><span class='line'>chef-client version: 13.8.5
</span><span class='line'>delivery version: master (73ebb72a6c42b3d2ff5370c476be800fee7e5427)
</span><span class='line'>berks version: 6.3.1
</span><span class='line'>kitchen version: 1.20.0
</span><span class='line'>inspec version: 1.51.21</span></code></pre></td></tr></table></div></figure>


<h3>Centos, Debian, Ubuntu&hellip;</h3>

<p><strong>N</strong>o CentOS, Ubuntu, Debian ou outras distribuições, o procedimento será relativamente parecido, portanto vejamos como seria no caso do CentOS baixando o arquivo diretamente do site de downloads:</p>

<p><strong>1- Baixar o arquivo .rpm para Red Hat:</strong> <a href="https://downloads.chef.io/chefdk">Aqui</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ wget https://packages.chef.io/files/stable/chefdk/2.5.3/el/7/chefdk-2.5.3-1.el7.x86_64.rpm</span></code></pre></td></tr></table></div></figure>


<p><strong>2- Instalar via RPM:</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo rpm -ivh chefdk-2.5.3-1.el7.x86_64.rpm</span></code></pre></td></tr></table></div></figure>


<p><strong>3- Confirmar que deu tudo certo:</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ chef --version
</span><span class='line'>
</span><span class='line'>Chef Development Kit Version: 2.5.3
</span><span class='line'>chef-client version: 13.8.5
</span><span class='line'>delivery version: master (73ebb72a6c42b3d2ff5370c476be800fee7e5427)
</span><span class='line'>berks version: 6.3.1
</span><span class='line'>kitchen version: 1.20.0
</span><span class='line'>inspec version: 1.51.21</span></code></pre></td></tr></table></div></figure>


<h2>Testando o Chef Localmente</h2>

<p><strong>P</strong>ara facilitar o entendimento, vamos criar uma recipe simples para aplicarmos localmente.</p>

<p><strong>V</strong>amos começar criando um arquivo chamado <strong>exemplo.rb</strong> com o seguinte conteúdo:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>package 'apache' do
</span><span class='line'>        package_name 'httpd'
</span><span class='line'>        action :install
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p><strong>O</strong> que temos aqui?</p>

<ul>
<li>Resource Type: package (Pois queremos instalar o pacote httpd)</li>
<li>Resource Name: apache (Embora o nome do pacote no CentOS seja httpd, o nome do nosso resource aqui é apache, mas poderia ser qualquer coisa que desejarmos)</li>
<li>Resource Properties: Aqui temos apenas <em>package_name</em> como propriedade, no qual damos o nome do pacote desejado. OBS: Caso não utilizemos a propriedade <em>package_name</em>, ele buscará por um pacote com mesmo nome do resource. No nosso caso, demos o nome <em>apache</em> para nosso resource, portanto ele buscaria por um pacote chamado <em>apache</em> e falharia, pois no CentOS este pacote não existe.</li>
<li>Actions: install (Temos apenas uma ação para esta recipe, que é justamente a de instalar o pacote, caso já não esteja instalado (idempotência))</li>
</ul>


<p><strong>S</strong>alve o arquivo e verifique o mesmo com os dois passos a seguir:</p>

<p><strong>1-</strong> Verifique se a sintaxe ruby está correta:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># ruby -c exemplo.rb
</span><span class='line'>
</span><span class='line'>Syntax OK</span></code></pre></td></tr></table></div></figure>


<p><strong>2-</strong> Utilize uma ferramenta do chef para verificar se a recipe está de acordo com o esperado pelo Chef:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># foodcritic exemplo.rb
</span><span class='line'>Checking 1 files
</span><span class='line'>x
</span><span class='line'>FC011: Missing README in markdown format: ../README.md:1
</span><span class='line'>FC031: Cookbook without metadata.rb file: ../metadata.rb:1
</span><span class='line'>FC071: Missing LICENSE file: ../LICENSE:1</span></code></pre></td></tr></table></div></figure>


<p>PS: Não se espante por enquanto com estes Warnings. Ele apenas está indicando que não possuímos um metadata, um readme e uma licença, pois não os criamos para este exemplo.</p>

<p><strong>V</strong>erificado o código e aprovado, vamos executar esta recipe localmente.
<em>(Repare no retorno que será apresentado, onde ele verifica o tipo de resource e identifica que estamos rodando em uma máquina CentoOS, portanto utiliza por padrão o yum para instalar o pacote desejado.)</em></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># chef-client --local-mode exemplo.rb
</span><span class='line'>
</span><span class='line'>[2018-04-01T19:18:00+00:00] WARN: No config file found or specified on command line, using command line options.
</span><span class='line'>[2018-04-01T19:18:00+00:00] WARN: No cookbooks directory found at or above current directory.  Assuming /root.
</span><span class='line'>Starting Chef Client, version 13.8.5
</span><span class='line'>resolving cookbooks for run list: []
</span><span class='line'>Synchronizing Cookbooks:
</span><span class='line'>Installing Cookbook Gems:
</span><span class='line'>Compiling Cookbooks...
</span><span class='line'>[2018-04-01T19:18:03+00:00] WARN: Node kalib6.mylabserver.com has an empty run list.
</span><span class='line'>Converging 1 resources
</span><span class='line'>Recipe: @recipe_files::/root/exemplo.rb
</span><span class='line'>  * yum_package[apache] action install
</span><span class='line'>    - install version 2.4.6-67.el7.centos.6 of package httpd
</span><span class='line'>
</span><span class='line'>Running handlers:
</span><span class='line'>Running handlers complete
</span><span class='line'>Chef Client finished, 1/1 resources updated in 16 seconds
</span><span class='line'>[2018-04-01T19:18:17+00:00] WARN: No config file found or specified on command line, using command line options.</span></code></pre></td></tr></table></div></figure>


<p><strong>S</strong>imples, certo? O pacote httpd (Apache) foi instalado em nosso CentOS. Verificando o status do serviço httpd, veremos que o serviço não está rodando e também não está ativo.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># systemctl status httpd
</span><span class='line'>● httpd.service - The Apache HTTP Server
</span><span class='line'>   Loaded: loaded (/usr/lib/systemd/system/httpd.service; disabled; vendor preset: disabled)
</span><span class='line'>   Active: inactive (dead)
</span><span class='line'>     Docs: man:httpd(8)
</span><span class='line'>           man:apachectl(8)</span></code></pre></td></tr></table></div></figure>


<p><strong>I</strong>sto está correto, afinal o Chef vai deixar a máquina no estado que determinamos. O determinado foi apenas instalar o pacote httpd. Mas de nada ele serve sem estar rodando como serviço, portanto vamos editar nossa recipe <em>exemplo.rb</em> e incluir nela um novo resource, desta vez um resource do tipo <em>service</em>, ou serviço. Sim, podemos ter diversos resources em uma mesma recipe. ;]</p>

<p><strong>E</strong>dite sua recipe para que ela possua o seguinte conteúdo:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>package 'apache' do
</span><span class='line'>        package_name 'httpd'
</span><span class='line'>        action :installchef_httpd_default.png
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>service 'httpd' do
</span><span class='line'>        action [:enable, :start]
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p><strong>O</strong> que adicionamos aqui?</p>

<ul>
<li>Resource Type: service (Pois queremos gerenciar o serviço httpd)</li>
<li>Resource Name: httpd (Poderíamos ter utilizado qualquer nome, mas para simplificar e não precisarmos utilizar uma propriedade de nome, deixaremos o resource com o nome do serviço, <em>httpd</em>)</li>
<li>Actions: enable e start (Como nosso objetivo é não apenas iniciar o serviço, mas também deixá-lo habilitado para ser iniciado automaticamente após reinicialização, utilizaremos o <em>enable</em> e o <em>start</em>) &ndash;> equivalente aos comandos <em>systemctl enable httpd</em> e <em>systemctl start httpd</em></li>
</ul>


<p><strong>N</strong>ovamente vamos verificar nosso código via ruby e foodcritic:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># ruby -c exemplo.rb && foodcritic exemplo.rb</span></code></pre></td></tr></table></div></figure>


<p><strong>E</strong> executando nossa recipe. (Novamente, o pacote httpd já está instalado, esta parte da recipe será ignorada automaticamente pelo Chef.)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># chef-client --local-mode exemplo.rb
</span><span class='line'>[2018-04-01T19:32:26+00:00] WARN: No config file found or specified on command line, using command line options.
</span><span class='line'>[2018-04-01T19:32:26+00:00] WARN: No cookbooks directory found at or above current directory.  Assuming /root.
</span><span class='line'>Starting Chef Client, version 13.8.5
</span><span class='line'>resolving cookbooks for run list: []
</span><span class='line'>Synchronizing Cookbooks:
</span><span class='line'>Installing Cookbook Gems:
</span><span class='line'>Compiling Cookbooks...
</span><span class='line'>[2018-04-01T19:32:28+00:00] WARN: Node kalib6.mylabserver.com has an empty run list.
</span><span class='line'>Converging 2 resources
</span><span class='line'>Recipe: @recipe_files::/root/exemplo.rb
</span><span class='line'>  * yum_package[apache] action install (up to date)
</span><span class='line'>  * service[httpd] action enable
</span><span class='line'>    - enable service service[httpd]
</span><span class='line'>  * service[httpd] action start
</span><span class='line'>    - start service service[httpd]
</span><span class='line'>
</span><span class='line'>Running handlers:
</span><span class='line'>Running handlers complete
</span><span class='line'>Chef Client finished, 2/3 resources updated in 06 seconds
</span><span class='line'>[2018-04-01T19:32:33+00:00] WARN: No config file found or specified on command line, using command line options.</span></code></pre></td></tr></table></div></figure>


<p><strong>A</strong>gora podemos verificar que nosso serviço httpd está de fato rodando.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># systemctl status httpd && ps aux | grep httpd
</span><span class='line'>● httpd.service - The Apache HTTP Server
</span><span class='line'>   Loaded: loaded (/usr/lib/systemd/system/httpd.service; enabled; vendor preset: disabled)
</span><span class='line'>   Active: active (running) since Sun 2018-04-01 19:32:33 UTC; 1min 17s ago
</span><span class='line'>     Docs: man:httpd(8)
</span><span class='line'>           man:apachectl(8)
</span><span class='line'> Main PID: 2409 (httpd)
</span><span class='line'>   Status: "Total requests: 0; Current requests/sec: 0; Current traffic:   0 B/sec"
</span><span class='line'>   CGroup: /system.slice/httpd.service
</span><span class='line'>           ├─2409 /usr/sbin/httpd -DFOREGROUND
</span><span class='line'>           ├─2410 /usr/sbin/httpd -DFOREGROUND
</span><span class='line'>           ├─2411 /usr/sbin/httpd -DFOREGROUND
</span><span class='line'>           ├─2412 /usr/sbin/httpd -DFOREGROUND
</span><span class='line'>           ├─2413 /usr/sbin/httpd -DFOREGROUND
</span><span class='line'>           └─2414 /usr/sbin/httpd -DFOREGROUND
</span><span class='line'>
</span><span class='line'>Apr 01 19:32:33 kalib6.mylabserver.com systemd[1]: Starting The Apache HTTP Server...
</span><span class='line'>Apr 01 19:32:33 kalib6.mylabserver.com systemd[1]: Started The Apache HTTP Server.
</span><span class='line'>root      2409  0.0  0.2 226040  4948 ?        Ss   19:32   0:00 /usr/sbin/httpd -DFOREGROUND
</span><span class='line'>apache    2410  0.0  0.1 226040  2872 ?        S    19:32   0:00 /usr/sbin/httpd -DFOREGROUND
</span><span class='line'>apache    2411  0.0  0.1 226040  2872 ?        S    19:32   0:00 /usr/sbin/httpd -DFOREGROUND
</span><span class='line'>apache    2412  0.0  0.1 226040  2872 ?        S    19:32   0:00 /usr/sbin/httpd -DFOREGROUND
</span><span class='line'>apache    2413  0.0  0.1 226040  2872 ?        S    19:32   0:00 /usr/sbin/httpd -DFOREGROUND
</span><span class='line'>apache    2414  0.0  0.1 226040  2872 ?        S    19:32   0:00 /usr/sbin/httpd -DFOREGROUND
</span><span class='line'>root      2425  0.0  0.0 112660   976 pts/0    R+   19:33   0:00 grep --color=auto httpd</span></code></pre></td></tr></table></div></figure>


<p><strong>A</strong>lém disso, você pode testar seu novo servidor web diretamente em seu navegador. Caso esteja executando tudo em localhost, pode utilizar <em>localhost</em> como endereço. Caso contrário, pode utilizar o endereço ip da máquina em questão.</p>

<p><img class="center" src="/imgs/chef_httpd_default.png" title="'Chef'" ></p>

<p><strong>A</strong> página padrão do Apache não é algo que queremos, portanto vamos criar nosso próprio site (Hello World) para exemplificar melhor. Para isto editaremos novamente nossa recipe e incluiremos mais um resource, do tipo <em>file</em>, ou arquivo. O conteúdo de sua recipe deverá ficar assim:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>package 'apache' do
</span><span class='line'>        package_name 'httpd'
</span><span class='line'>        action :install
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>service 'httpd' do
</span><span class='line'>        action [:enable, :start]
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>file '/var/www/html/index.html' do
</span><span class='line'>        content 'Hello World!'
</span><span class='line'>        mode '0755'
</span><span class='line'>        owner 'root'
</span><span class='line'>        group 'apache'
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p><strong>O</strong> que adicionamos aqui?</p>

<ul>
<li>Resource Type: file (Pois queremos gerenciar o nosso arquivo index.html, o qual, caso não exista, será criado)</li>
<li>Resource Name: /var/www/html/index.html (Poderíamos ter utilizado qualquer nome, mas para simplificar e não precisarmos utilizar uma propriedade de nome, deixaremos o resource com o nome do arquivo que vamos utilizar, <em>/var/www/html/index.html</em>)</li>
<li>Content: Hello World! (Para simplificar teremos uma simples string <em>Hello World!</em> como conteúdo de nosso site)</li>
<li>Mode: Permissão que desejamos atribuir ao arquivo index.html</li>
<li>Owner: Dono que deve ser atribuído ao arquivo index.html</li>
<li>Group: Grupo que deve ser atribuído ao arquivo index.html</li>
</ul>


<p><strong>N</strong>ovamente vamos verificar nosso código via ruby e foodcritic:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># ruby -c exemplo.rb && foodcritic exemplo.rb</span></code></pre></td></tr></table></div></figure>


<p><strong>E</strong> executaremos novamente nossa recipe. (Assim como anteriormente, o Chef ignorará as instruções referentes aos resources que já se encontram no estado desejado)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># chef-client --local-mode exemplo.rb          
</span><span class='line'>[2018-04-01T19:48:00+00:00] WARN: No config file found or specified on command line, using command line options.
</span><span class='line'>[2018-04-01T19:48:00+00:00] WARN: No cookbooks directory found at or above current directory.  Assuming /root.
</span><span class='line'>Starting Chef Client, version 13.8.5
</span><span class='line'>resolving cookbooks for run list: []
</span><span class='line'>Synchronizing Cookbooks:
</span><span class='line'>Installing Cookbook Gems:
</span><span class='line'>Compiling Cookbooks...
</span><span class='line'>[2018-04-01T19:48:02+00:00] WARN: Node kalib6.mylabserver.com has an empty run list.
</span><span class='line'>Converging 3 resources
</span><span class='line'>Recipe: @recipe_files::/root/exemplo.rb
</span><span class='line'>  * yum_package[apache] action install (up to date)
</span><span class='line'>  * service[httpd] action enable (up to date)
</span><span class='line'>  * service[httpd] action start (up to date)
</span><span class='line'>  * file[/var/www/html/index.html] action create
</span><span class='line'>    - create new file /var/www/html/index.html
</span><span class='line'>    - update content in file /var/www/html/index.html from none to 7f83b1
</span><span class='line'>    --- /var/www/html/index.html        2018-04-01 19:48:06.829566745 +0000
</span><span class='line'>    +++ /var/www/html/.chef-index20180401-2631-164958p.html     2018-04-01 19:48:06.829566745 +0000
</span><span class='line'>    @@ -1 +1,2 @@
</span><span class='line'>    +Hello World!
</span><span class='line'>    - change mode from '' to '0755'
</span><span class='line'>    - change owner from '' to 'root'
</span><span class='line'>    - change group from '' to 'apache'
</span><span class='line'>    - restore selinux security context
</span><span class='line'>
</span><span class='line'>Running handlers:
</span><span class='line'>Running handlers complete
</span><span class='line'>Chef Client finished, 1/4 resources updated in 06 seconds
</span><span class='line'>[2018-04-01T19:48:07+00:00] WARN: No config file found or specified on command line, using command line options.</span></code></pre></td></tr></table></div></figure>


<p><strong>P</strong>odemos verificar que o Chef criou o nosso arquivo index.html, atribuindo o dono, grupo e permissão que indicamos:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># ls -lh /var/www/html/
</span><span class='line'>total 4.0K
</span><span class='line'>-rwxr-xr-x. 1 root apache 12 Apr  1 19:48 index.html</span></code></pre></td></tr></table></div></figure>


<p><strong>T</strong>ambém podemos voltar em nosso navegador e atualizar a página para que vejamos o nosso Hello World ao invés da página padrão do Apache.</p>

<p><img class="center" src="/imgs/chef_httpd_hw.png" title="'Chef'" ></p>

<h2>Vale a pena?</h2>

<p><strong>R</strong>ealizar este processo manualmente na mesma máquina CentoOS seria mais rápido do que utilizando o Chef. Vamos rever:</p>

<p><strong>O</strong> que precisamos?</p>

<ul>
<li>Instalar o pacote httpd</li>
<li>Habilitar e Iniciar o serviço httpd</li>
<li>Criar o arquivo index.html com o conteúdo &ldquo;Hello World!&rdquo;</li>
</ul>


<p><strong>F</strong>azendo manualmente seria apenas uma questão de executarmos 4 comandos:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># yum install httpd
</span><span class='line'>
</span><span class='line'># systemctl enable httpd && systemctl start httpd
</span><span class='line'>
</span><span class='line'># echo "Hello World!" &gt; /var/www/html/index.html
</span><span class='line'>
</span><span class='line'># chmod 0755 /var/www/html/index.html && chown root:apache /var/www/html/index.html</span></code></pre></td></tr></table></div></figure>


<p><strong>S</strong>im, é verdade que fazendo manualmente neste caso seria MUITO mais rápido. O importante é lembrar do que falamos anteriormente: E se não for apenas 1 servidor? E se for um grupo? E se ao invés de apenas 3 resources, tiver 15? ou 40? E se alguém modificar algo em algum dos resources? Como você saberá qual foi? Vai verificar todos um a um para identificar o que precisa ser corrigido?</p>

<h1>Vantagens:</h1>

<p><strong>I</strong>magine que algum membro de sua equipe alterou a permissão do arquivo index.html sem lhe avisar, por exemplo ele foi lá e&hellip;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># chmod 0666 /var/www/html/index.html</span></code></pre></td></tr></table></div></figure>


<p><strong>L</strong>embrando que em nossa recipe exemplo.rb, definimos a permissão 0755. Neste caso, sempre que executarmos a recipe, o Chef irá verificar todos os resources e corrigir o que quer que tenha sido alterado.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># chef-client --local-mode exemplo.rb
</span><span class='line'>[2018-04-01T20:04:08+00:00] WARN: No config file found or specified on command line, using command line options.
</span><span class='line'>[2018-04-01T20:04:08+00:00] WARN: No cookbooks directory found at or above current directory.  Assuming /root.
</span><span class='line'>Starting Chef Client, version 13.8.5
</span><span class='line'>resolving cookbooks for run list: []
</span><span class='line'>Synchronizing Cookbooks:
</span><span class='line'>Installing Cookbook Gems:
</span><span class='line'>Compiling Cookbooks...
</span><span class='line'>[2018-04-01T20:04:10+00:00] WARN: Node kalib6.mylabserver.com has an empty run list.
</span><span class='line'>Converging 3 resources
</span><span class='line'>Recipe: @recipe_files::/root/exemplo.rb
</span><span class='line'>  * yum_package[apache] action install (up to date)
</span><span class='line'>  * service[httpd] action enable (up to date)
</span><span class='line'>  * service[httpd] action start (up to date)
</span><span class='line'>  * file[/var/www/html/index.html] action create
</span><span class='line'>    - change mode from '0666' to '0755'
</span><span class='line'>    - restore selinux security context
</span><span class='line'>
</span><span class='line'>Running handlers:
</span><span class='line'>Running handlers complete
</span><span class='line'>Chef Client finished, 1/4 resources updated in 06 seconds
</span><span class='line'>[2018-04-01T20:04:14+00:00] WARN: No config file found or specified on command line, using command line options.</span></code></pre></td></tr></table></div></figure>


<p><strong>R</strong>epare na linha <em>&ndash; change mode from &lsquo;0666&rsquo; to &lsquo;0755&rsquo;</em>. O Chef acabou de corrigir automaticamente sem que nós tenhamos de vasculhar cada componente e arquivo em nosso servidor para saber o que foi alterado ou o que está diferente do estado desejado. Novamente, aqui tratamos de um servidor único, com apenas um arquivo. Imagine ter que varrer manualmente diversos servidores e diversos arquivos e diretórios?</p>

<p><strong>N</strong>este exemplo, provavelmente o site poderia continuar funcionando, pois foi alterada apenas a permissão de um único arquivo, certo? Mas imagine que sem querer ele acabou parando o serviço httpd, ou até desinstalou o mesmo? Em uma instalação padrão com Chef Server, existem agendamentos que fazem com que o Chef execute as recipes a cada X minutos, portanto o serviço seria inicializado novamente automaticamente, ou mesmo instalado caso necessário.</p>

<p><strong>É</strong> fácil imaginar diversos cenários nos quais seria útil ter a sua infraestrutura em formato de código.</p>

<p><strong>I</strong>magine uma catástrofe em que seu servidor simplesmente parou de funcionar e você precisará criar outro. Novamente você teria que executar aqueles comandos. Se desde o início tivesse utilizado Chef, ou outra ferramenta de Gerenciamento de Configuração, você poderia ter a sua recipe armazenada em um repositório Git, por exemplo, conforme mencionado no início deste post, e bastaria apenas executar o seu chef-client para instalar os pacotes necessários, habilitar e inicializar serviços, criar arquivos, etc.</p>

<p><strong>A</strong> imaginação é o seu limite. ;]</p>

<p><strong>E</strong>m posts futuros pretendo explorar mais a fundo o Chef, bem como outras ferramentas.</p>

<p><strong>H</strong>appy Hacking!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/06/24/conhecendo-o-kubernetes-clusters-de-containers/">Conhecendo O Kubernetes - Clusters De Containers</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2017-06-24T09:32:00-04:00" pubdate data-updated="true">Jun 24<span>th</span>, 2017</time>
        
         | <a href="/blog/2017/06/24/conhecendo-o-kubernetes-clusters-de-containers/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img class="center" src="/imgs/kubernetes_logo.png" title="'Kubernetes'" ></p>

<h2>O que é Kubernetes</h2>

<p><strong>K</strong>ubernetes é uma solução Open Source desenvolvida pelo Google, originalmente chamada de K8s, como uma ferramenta para gerenciar clusters de containers (ou containeres, como prefira). Em 2005, quando a ferramenta foi desenvolvida, originalmente para uso interno, o Google doou o código à recém fundada <a href="https://www.cncf.io/">Cloud Native Computing Foundation</a>, em parceria com a <a href="https://www.linuxfoundation.org/">The Linux Foundation</a>.</p>

<p><strong>O</strong> motivo do leme em sua logomarca é devido à origem grega da palavra, que vem de Kuvernetes, que representa a pessoa que pilota o navio, timoneiro.</p>

<p><strong>C</strong>omo objetivo primário o Kubernetes provê uma plataforma de automação para deployments, escalonamento e operações de containers de aplicações em um cluster de hosts ou nodes.</p>

<p><strong>A</strong>ntes de seguir com a explicação, instalação e configuração do Kubernetes, estou supondo que você já possui algum conhecimento básico sobre o que sejam containers e tenha alguma familiaridade com o <a href="https://www.docker.com">Docker</a>. Caso não possua um entendimento básico sobre containers e Docker, sugiro que leia algo antes de seguir com este artigo. Possuo um post introdutório sobre containers com um exemplo básico e prático sobre como criar containers com Docker, bem como iniciar uma simples aplicação web &ndash;  <a href="/blog/2015/08/20/docker-uma-alternativa-elegante-para-containers-no-linux/">aqui</a>.</p>

<p><strong>O</strong> Kubernetes é formado por uma série de componentes ou blocos que, quando utilizados coletivamente, fornecem um método de deployment, manutenção e escalonamento de clusters de aplicações baseadas em containers. Estes componentes, ou primitives como o Kubernetes os chama, foram desenvolvidos com o intuito de serem independentes, de forma que quase não se faz necessário ter conhecimento entre si para que possam funcionar e trabalhar juntos, visto que todos se comunicam e interligam através de uma API, sejam componentes internos do Kubernetes ou mesmo extensões e containers.</p>

<p><strong>E</strong>mbora tenha sido inicialmente desenvolvido para o deployment e utilização de <strong>bilhões de containers</strong> internamente no Google, desde que seu código passou a ser distribuído abertamente com a licença <a href="http://commons.apache.org/proper/commons-daemon/license.html">Apache Commons</a> o Kubernetes tem sido adotado formalmente por praticamente todos os grandes provedores de serviços em nuvem.</p>

<h2>Arquitetura do Kubernetes</h2>

<p><img class="center" src="/imgs/kubernetes_architecture.png" title="'Kubernetes Architecture'" ></p>

<p><strong>D</strong>entre os principais componentes do Kubernetes, vamos destacar os seguintes:</p>

<ul>
<li><p><strong>Master ou Master Controller</strong> &ndash; Host que será o gerenciador principal do Kubernetes, responsável por gerenciar os Minions ou Nodes do Cluster;</p></li>
<li><p><strong>Nodes ou Minions</strong> &ndash; Embora normalmente a nomenclatura em diversos serviços de tecnolocia seja Node, o Kubernetes prefere chamar de Minions os hosts que fazem parte de um Cluster gerenciado pelo próprio Kubernetes. Este minion pode ser um servidor físico ou virtual, necessitando possuir um serviço de gerenciamento de containers, como o Docker, por exemplo;</p></li>
<li><p><strong>ETCD</strong> &ndash; Embora este seja um serviço independente, estou listando-o aqui pois este será fundamental em seu ciclo de desenvolvimento com o Kubernetes. Cada Minion deverá rodar o <a href="https://coreos.com/etcd/docs/latest/">ETCD</a> (serviço de comunicação e gerenciamento de configurações no formato par de Chave/Valor). O ETCD é utilizado para troca e armazenamento de informações sobre os containers, pods, minions, etc.</p></li>
<li><p><strong>Pods</strong> &ndash; São grupos de containers (um ou mais) rodando em um único minion do cluster. Cada Pod receberá um endereço IP único no Cluster como forma de possibilitar a utilização de portas sem a necessidade de se preocupar com conflitos;</p></li>
<li><p><strong>Labels</strong> &ndash; São informações de identificação na configuração e gerenciamento dos objetos (como Pods ou Minions) formados de pares &ldquo;chave:valor&rdquo;;</p></li>
<li><p><strong>Controllers</strong> &ndash; Além do Master Controller, dependendo do tamanho de sua infraestrutura e quantidade de Pods e Minions, você pode optar por ter mais de um Controller para dividir a carga e tarefas de gerenciamento. Os Controllers gerenciam um grupo de pods e, dependendo do estado de configuração desejada, podem acionar outros Controllers para lidar com as replicações e escalonamento. Os Controllers também são responsáveis pela substituiçao de Pods, caso um entre em estado de falha.</p></li>
</ul>


<h2>Instalação</h2>

<p><strong>V</strong>amos ao que interessa&hellip;</p>

<p><strong>N</strong>ovamente estou supondo que você já possui alguma familiaridade com Containers, Docker e, por consequência, com GNU/Linux.</p>

<p><strong>E</strong>estarei utilizando 4 servidores virtuais rodando CentOS 7 nos exemplos a seguir, mas fica a seu critério decidir quantos utilizar.</p>

<p><em>Certamente você optar por utilizar outra distribuição, seja Debian, Ubuntu, etc.. Uma vez que optei pelo CentOS 7, estarei utilizando comandos voltados para esta distro, mas sinta-se livre para adaptar seus comandos, como substituir o &ldquo;yum&rdquo; pelo &ldquo;apt-get&rdquo;, &ldquo;pacman&rdquo;, etc..</em></p>

<p><strong>E</strong>m minha configuração chamarei os servidores da seguinte forma:</p>

<ul>
<li>centos-master</li>
<li>centos-minion1</li>
<li>centos-minion2</li>
<li>centos-minion3</li>
</ul>


<p><strong>A</strong> primeira coisa que se deve fazer sempre que se pensa em trabalhar com clusters, independente de ser um cluster de containers ou não, é ter a certeza de que os servidores terão uma correta sincronização de relógios entre si. A forma mais simples e eficiente no nosso contexto é com a utilização do NTP, portanto comece instalando o NTP nos 4 servidores, bem como habilitando o serviço e iniciando-o:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># yum install -y ntp</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># systemctl enable ntpd && systemctl start ntpd</span></code></pre></td></tr></table></div></figure>


<p><strong>C</strong>aso queira certificar-se de que o serviço está realmente rodando:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># systemctl status ntpd
</span><span class='line'>
</span><span class='line'>● ntpd.service - Network Time Service
</span><span class='line'>   Loaded: loaded (/usr/lib/systemd/system/ntpd.service; enabled; vendor preset: disabled)
</span><span class='line'>   Active: active (running) since Sat 2017-06-24 17:46:02 UTC; 3s ago
</span><span class='line'>  Process: 1586 ExecStart=/usr/sbin/ntpd -u ntp:ntp $OPTIONS (code=exited, status=0/SUCCESS)
</span><span class='line'> Main PID: 1587 (ntpd)
</span><span class='line'>   Memory: 2.1M
</span><span class='line'>   CGroup: /system.slice/ntpd.service
</span><span class='line'>           └─1587 /usr/sbin/ntpd -u ntp:ntp -g</span></code></pre></td></tr></table></div></figure>


<p><strong>P</strong>inga?</p>

<p><strong>É</strong> importante nos certificarmos de que os servidores conseguem se comunicar e de que conseguem resolver nomes corretamente.</p>

<p><strong>N</strong>este exemplo, conforme informado mais acima, estamos utilizando 4 servidores com os seguintes nomes: <em>centos-master</em>, <em>centos-minion1</em>, <em>centos-minion2</em> e <em>centos-minion3</em>, portanto vamos editar o arquivo <strong>/etc/hosts</strong> de cada um deles para que possam se comunicar pelos nomes que desejamos:</p>

<p><strong>Insira as seguintes linhas no arquivo /etc/hosts dos 4 servidores:</strong></p>

<p><em>Lembre-se de substituir os IPs pelos IPs dos servidores em seu ambiente</em></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># Ip local do servidor master
</span><span class='line'>172.31.22.126   centos-master
</span><span class='line'>
</span><span class='line'># Ip local do minion1
</span><span class='line'>172.31.120.16   centos-minion1
</span><span class='line'>
</span><span class='line'># Ip local do minion2
</span><span class='line'>172.31.25.6     centos-minion2
</span><span class='line'>
</span><span class='line'># Ip local do minion3
</span><span class='line'>172.31.123.22   centos-minion3</span></code></pre></td></tr></table></div></figure>


<p>Feito isto, tente pingar do master para os 3 minions utilizando os nomes especificados no /etc/hosts:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@kalib1 ~]# ping centos-minion1
</span><span class='line'>PING centos-minion1 (172.31.120.16) 56(84) bytes of data.
</span><span class='line'>64 bytes from centos-minion1 (172.31.120.16): icmp_seq=1 ttl=64 time=1.06 ms
</span><span class='line'>
</span><span class='line'>[root@kalib1 ~]# ping centos-minion2
</span><span class='line'>PING centos-minion2 (172.31.25.6) 56(84) bytes of data.
</span><span class='line'>64 bytes from centos-minion2 (172.31.25.6): icmp_seq=1 ttl=64 time=0.588 ms
</span><span class='line'>
</span><span class='line'>[root@kalib1 ~]# ping centos-minion3
</span><span class='line'>PING centos-minion3 (172.31.123.22) 56(84) bytes of data.
</span><span class='line'>64 bytes from centos-minion3 (172.31.123.22): icmp_seq=1 ttl=64 time=1.24 ms</span></code></pre></td></tr></table></div></figure>


<p><strong>V</strong>ocê pode realizar o mesmo teste a partir dos minions, pingando entre si e também para o centos-master.</p>

<p><strong>U</strong>ma vez que tenhamos certeza de que todos os hosts se comunicam, é hora de instalar mais alguns pacotes necessários.</p>

<p><strong>P</strong>rimeiramente, vamos configurar o repositório do Docker para o CentOS 7:</p>

<ul>
<li>Configurações de repositório retiradas dos repositórios CBS do Centos: <a href="http://cbs.centos.org/repos/virt7-docker-common-release/">http://cbs.centos.org/repos/virt7-docker-common-release/</a></li>
</ul>


<p><strong>V</strong>amos criar o seguinte arquivo de repositório:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># vim /etc/yum.repos.d/virt7-docker-common-release.repos</span></code></pre></td></tr></table></div></figure>


<p><strong>O</strong> conteúdo deste arquivo será o seguinte:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[virt7-docker-common-release]
</span><span class='line'>name=virt7-docker-common-release
</span><span class='line'>baseurl=http://cbs.centos.org/repos/virt7-docker-common-release/x86_64/os/
</span><span class='line'>gpgcheck=0</span></code></pre></td></tr></table></div></figure>


<p><em>Este arquivo deverá ser criado nos 4 servidores.</em></p>

<p><strong>E</strong>m seguida, vamos atualizar a nossa base de repositórios e pacotes, também <strong>nos 4 servidores</strong>, bem como habilitar o novo repositório para instalar os pacotes docker e kubernetes:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># yum update</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># yum install -y --enablerepo=virt7-docker-common-release docker kubernetes</span></code></pre></td></tr></table></div></figure>


<p><strong>C</strong>omo dito na introdução, também precisaremos do etcd para o armazenamento e troca de configurações, portanto vamos instalá-lo também nos 4 hosts:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># yum instal -y etcd</span></code></pre></td></tr></table></div></figure>


<h2>Configuração</h2>

<p><strong>V</strong>amos começar com a configuração básica dos serviços envolvidos. Primeiramente, vamos abrir o arquivo de configuração do kubernetes e fazer algumas alterações:</p>

<p><em>/etc/kubernetes/config</em></p>

<p><strong>N</strong>o arquivo config altere as seguintes linhas:</p>

<p><em>Edite o valor do parâmetro KUBE_MASTER, de forma que nosso master possa ser encontrado pelo nome que definimos no hosts file. O valor original é &ldquo;&mdash;master=<a href="http://127.0.0.1:8080">http://127.0.0.1:8080</a>&rdquo;, portanto mudaremos para o seguinte:</em></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>KUBE_MASTER="--master=http://centos-master:8080"</span></code></pre></td></tr></table></div></figure>


<p><strong>A</strong>inda neste arquivo de configuração, vamos inserir a configuração do serviço ETCD, portanto inclua a seguinte linha ao final do arquivo:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>KUBE_ETCD_SERVERS="--etcd-servers=http://centos-master:2379"</span></code></pre></td></tr></table></div></figure>


<p><strong>S</strong>eu arquivo de configuração deverá estar similar a este:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>###
</span><span class='line'># kubernetes system config
</span><span class='line'>#
</span><span class='line'># The following values are used to configure various aspects of all
</span><span class='line'># kubernetes services, including
</span><span class='line'>#
</span><span class='line'>#   kube-apiserver.service
</span><span class='line'>#   kube-controller-manager.service
</span><span class='line'>#   kube-scheduler.service
</span><span class='line'>#   kubelet.service
</span><span class='line'>#   kube-proxy.service
</span><span class='line'># logging to stderr means we get it in the systemd journal
</span><span class='line'>KUBE_LOGTOSTDERR="--logtostderr=true"
</span><span class='line'>
</span><span class='line'># journal message level, 0 is debug
</span><span class='line'>KUBE_LOG_LEVEL="--v=0"
</span><span class='line'>
</span><span class='line'># Should this cluster be allowed to run privileged docker containers
</span><span class='line'>KUBE_ALLOW_PRIV="--allow-privileged=false"
</span><span class='line'>
</span><span class='line'># How the controller-manager, scheduler, and proxy find the apiserver
</span><span class='line'>KUBE_MASTER="--master=http://centos-master:8080"
</span><span class='line'>
</span><span class='line'>KUBE_ETCD_SERVERS="--etcd-servers=http://centos-master:2379"</span></code></pre></td></tr></table></div></figure>


<p><strong>R</strong>epita esta mesma configuração nos 4 hosts. Todos eles devem utilizar exatamente os mesmos valores utilizados aqui, apontando KUBE_MASTER e KUBE_ETCD_SERVERS para centos-master, visto que este será o responsável por gerenciar todos os nossos minions.</p>

<p><strong>U</strong>ma vez que o arquivo de configuração do kubernetes esteja pronto nos 4 hosts, vamos configurar o serviço de API do kubernetes:</p>

<p><em>/etc/kubernetes/apiserver</em></p>

<p><strong>Esta configuração abaixo será apenas para o Master.</strong></p>

<p><em>Edite o valor do parâmetro KUBE_API_ADDRESS, que originalmente é &ldquo;&mdash;insecure-bind-address=127.0.0.1&rdquo;, de forma que possamos novamente receber comunicação dos demais hosts.</em></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>KUBE_API_ADDRESS="--address=0.0.0.0"</span></code></pre></td></tr></table></div></figure>


<p><em>Descomente as linhas KUBE_API_PORT e KUBELET_PORT, para que possamos estabelecer as portas de comunicação com a API:</em></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># The port on the local server to listen on.
</span><span class='line'>KUBE_API_PORT="--port=8080"
</span><span class='line'>
</span><span class='line'># Port minions listen on
</span><span class='line'>KUBELET_PORT="--kubelet-port=10250"</span></code></pre></td></tr></table></div></figure>


<p><em>Em nosso exemplo não utilizaremos o parâmetro KUBE_ADMISSION_CONTROL, o qual nos permite ter mais controles e restrições sobre quais nodes ou minios podem entrar em nosso ambiente, portanto vamos apenas comentar esta linha por enquanto:</em></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># default admission control policies
</span><span class='line'># KUBE_ADMISSION_CONTROL="--admission-control=NamespaceLifecycle,NamespaceExists,LimitRanger,SecurityContextDeny,ServiceAccount,ResourceQuota"</span></code></pre></td></tr></table></div></figure>


<p><em>Nosso arquivo /etc/kubernetes/apiserver deverá estar assim:</em></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>##
</span><span class='line'># kubernetes system config
</span><span class='line'>#
</span><span class='line'># The following values are used to configure the kube-apiserver
</span><span class='line'>#
</span><span class='line'>
</span><span class='line'># The address on the local server to listen to.
</span><span class='line'>KUBE_API_ADDRESS="--address=0.0.0.0"
</span><span class='line'>
</span><span class='line'># The port on the local server to listen on.
</span><span class='line'>KUBE_API_PORT="--port=8080"
</span><span class='line'>
</span><span class='line'># Port minions listen on
</span><span class='line'>KUBELET_PORT="--kubelet-port=10250"
</span><span class='line'>
</span><span class='line'># Comma separated list of nodes in the etcd cluster
</span><span class='line'>KUBE_ETCD_SERVERS="--etcd-servers=http://127.0.0.1:2379"
</span><span class='line'>
</span><span class='line'># Address range to use for services
</span><span class='line'>KUBE_SERVICE_ADDRESSES="--service-cluster-ip-range=10.254.0.0/16"
</span><span class='line'>
</span><span class='line'># default admission control policies
</span><span class='line'># KUBE_ADMISSION_CONTROL="--admission-control=NamespaceLifecycle,NamespaceExists,LimitRanger,SecurityContextDeny,ServiceAccount,ResourceQuota"
</span><span class='line'>
</span><span class='line'># Add your own!
</span><span class='line'>KUBE_API_ARGS=""</span></code></pre></td></tr></table></div></figure>


<p><strong>S</strong>alve e feche o arquivo. Novamente, esta configuração deve ser feita apenas para o Master.</p>

<p><strong>A</strong>gora vamos configurar o serviço ETCD:</p>

<p><em>/etc/etcd/etcd.conf</em></p>

<p><strong>Esta configuração abaixo será apenas para o Master.</strong></p>

<p><em>Edite os valores dos parâmetros ETCD_LISTEN_CLIENT_URLS e ETCD_ADVERTISE_CLIENT_URLS, que originalmente apontam para localhost. Como desejamos que nosso etcd escute requisições dos demais hosts, altere para o seguinte:</em></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ETCD_LISTEN_CLIENT_URLS="http://0.0.0.0:2379"
</span><span class='line'>...
</span><span class='line'>...
</span><span class='line'>ETCD_ADVERTISE_CLIENT_URLS="http://0.0.0.0:2379"</span></code></pre></td></tr></table></div></figure>


<p><strong>N</strong>ovamente, não é necessário alterar a configuração do etcd nos demais hosts, apenas no Master.</p>

<p><strong>U</strong>ma vez que as configurações iniciais foram feitas, vamos habilitar e iniciar os serviços necessários <strong>no Master</strong>, sendo eles:</p>

<ul>
<li>etcd</li>
<li>kube-apiserver</li>
<li>kube-controller-manager</li>
<li>kube-scheduler</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># systemctl enable etcd kube-apiserver kube-controller-manager kube-scheduler</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># systemctl start etcd kube-apiserver kube-controller-manager kube-scheduler</span></code></pre></td></tr></table></div></figure>


<p><strong>O</strong>s 4 serviços devem estar rodando. Para termos certeza, vamos checar o status dos mesmos:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># systemctl status etcd kube-apiserver kube-controller-manager kube-scheduler | grep "(running)"
</span><span class='line'>   Active: active (running) since Sat 2017-06-24 21:45:37 UTC; 1min ago
</span><span class='line'>   Active: active (running) since Sat 2017-06-24 21:46:13 UTC; 1min ago
</span><span class='line'>   Active: active (running) since Sat 2017-06-24 21:44:25 UTC; 1min ago
</span><span class='line'>   Active: active (running) since Sat 2017-06-24 21:44:25 UTC; 1min ago</span></code></pre></td></tr></table></div></figure>


<p><strong>N</strong>ovamente, estes serviços serão iniciados no Master, e não nos nodes/minions, visto que estes utilizarão outros serviços.</p>

<p><strong>A</strong>gora vamos configurar o seguinte arquivo nos nodes/minions:</p>

<p><em>/etc/kubernetes/kubelet</em></p>

<p><strong>Este arquivo apenas deverá ser editado nos nodes/minions, não no Master.</strong></p>

<p><em>Vamos alterar o valor do parâmetro KUBELET_ADDRESS para que aceite comunicação não apenas do localhost:</em></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>KUBELET_ADDRESS="--address=0.0.0.0"</span></code></pre></td></tr></table></div></figure>


<p><em>Descomentaremos também a linha KUBELET_PORT, para que possamos ter uma porta definida para a comunicação do kubelet:</em></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># The port for the info server to serve on
</span><span class='line'>KUBELET_PORT="--port=10250"</span></code></pre></td></tr></table></div></figure>


<p><em>Vamos alterar o valor do parâmetro KUBELET_HOSTNAME para o nome que definimos <strong>para cada um dos minions</strong>, portanto em cada um deles este será um valor diferente. Supondo que este seja o minion1, utilizaremos:</em></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>KUBELET_HOSTNAME="--hostname-override=centos-minion1"</span></code></pre></td></tr></table></div></figure>


<p><em>Vamos também alterar o valor para KUBELET_API_SERVER, apontando para o nosso Master:</em></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>KUBELET_API_SERVER="--api-servers=http://centos-master:8080"</span></code></pre></td></tr></table></div></figure>


<p><em>Vamos comentar a linha KUBELET_POD_INFRA_CONTAINER, visto que não utilizaremos uma infraestrutura de containers externa, pois estaremos utilizando nossos próprios PODs e containers:</em></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># pod infrastructure container
</span><span class='line'>#KUBELET_POD_INFRA_CONTAINER="--pod-infra-container-image=registry.access.redhat.com/rhel7/pod-infrastructure:latest"</span></code></pre></td></tr></table></div></figure>


<p><em>Nosso arquivo deverá estar assim: (Lembrando que o parâmetro KUBELET_HOSTNAME deverá ser diferente para cada um dos 3 minions, respectivamente: centos-minion1, centos-minion2 e centos-minion3)</em></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>###
</span><span class='line'># kubernetes kubelet (minion) config
</span><span class='line'>
</span><span class='line'># The address for the info server to serve on (set to 0.0.0.0 or "" for all interfaces)
</span><span class='line'>KUBELET_ADDRESS="--address=0.0.0.0"
</span><span class='line'>
</span><span class='line'># The port for the info server to serve on
</span><span class='line'>KUBELET_PORT="--port=10250"
</span><span class='line'>
</span><span class='line'># You may leave this blank to use the actual hostname
</span><span class='line'>KUBELET_HOSTNAME="--hostname-override=centos-minion1"
</span><span class='line'>
</span><span class='line'># location of the api-server
</span><span class='line'>KUBELET_API_SERVER="--api-servers=http://centos-master:8080"
</span><span class='line'>
</span><span class='line'># pod infrastructure container
</span><span class='line'>#KUBELET_POD_INFRA_CONTAINER="--pod-infra-container-image=registry.access.redhat.com/rhel7/pod-infrastructure:latest"
</span><span class='line'>
</span><span class='line'># Add your own!
</span><span class='line'>KUBELET_ARGS=""</span></code></pre></td></tr></table></div></figure>


<p><strong>U</strong>ma vez que estas configurações também estão feitas nos 3 minions, vamos habilitar e iniciar os serviços necessários nos minions:</p>

<ul>
<li>kube-proxy</li>
<li>kube-kubelet</li>
<li>docker</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># systemctl enable kube-proxy kubelet docker</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># systemctl start kube-proxy kubelet docker</span></code></pre></td></tr></table></div></figure>


<p><strong>N</strong>ovamente, vamos ter certeza de que os 3 serviços estão rodando:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># systemctl status kube-proxy kubelet docker | grep "(running)"
</span><span class='line'>   Active: active (running) since Sat 2017-06-24 21:44:23 UTC; 1h 16min ago
</span><span class='line'>   Active: active (running) since Sat 2017-06-24 21:44:27 UTC; 1h 16min ago
</span><span class='line'>   Active: active (running) since Sat 2017-06-24 21:44:27 UTC; 1h 16min ago</span></code></pre></td></tr></table></div></figure>


<p><strong>N</strong>ovamente, estes 3 serviços devem ser habilitados e iniciados nos 3 minions.</p>

<p><strong>N</strong>este momento já temos nosso cluster rodando, com um master e 3 minions. :D</p>

<h2>Testando o Cluster com o Kubernetes</h2>

<p><strong>A</strong>gora que temos a configuração básica de nosso Master Controller e de 3 minions, vamos testar nosso cluster.</p>

<p><strong>U</strong>tilizaremos o utilitário kubectl (KubeControl) disponível com o kubernetes. Caso tenha interesse em ver os parâmetros e funções do mesmo&hellip; <em>$ man kubectl</em></p>

<p><strong>V</strong>amos verificar a lista dos nodes ou minions que temos neste momento registrados em nosso Cluster. Vamos digitar alguns comandos em nosso Master Controller (centos-master):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@kalib1 ~]# kubectl get nodes
</span><span class='line'>NAME             STATUS    AGE
</span><span class='line'>centos-minion1   Ready     17m
</span><span class='line'>centos-minion2   Ready     15m
</span><span class='line'>centos-minion3   Ready     10m</span></code></pre></td></tr></table></div></figure>


<p><strong>O</strong>s três nodes criados e configurados anteriormente já são reconhecidos pelo nosso Kubernetes através do Master Controller. Além de registrados, estão com o status Ready, o que indica que estão prontos para funcionar e executar o que precisarmos.</p>

<p><em>Caso deseje conhecer mais parâmetros que a função <strong>get</strong> do kubectl possui, podemos invocar o manual desta função: $ man kubectl-get</em></p>

<p><strong>A</strong>lém do status, podemos conseguir diversas outras informações dos nodes através do <em>kubectl</em>: <em>(Ex: kubectl describe nodes)</em> Isto lhe daria informações sobre todos os nodes. Vamos experimentar com um node em específico.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@kalib1 ~]# kubectl describe node centos-minion1
</span><span class='line'>Name:                   centos-minion1
</span><span class='line'>Role:
</span><span class='line'>Labels:                 beta.kubernetes.io/arch=amd64
</span><span class='line'>                        beta.kubernetes.io/os=linux
</span><span class='line'>                        kubernetes.io/hostname=centos-minion1
</span><span class='line'>Taints:                 &lt;none&gt;
</span><span class='line'>CreationTimestamp:      Tue, 20 Jun 2017 19:27:31 +0000
</span><span class='line'>Phase:
</span><span class='line'>Conditions:
</span><span class='line'>  Type                  Status  LastHeartbeatTime                       LastTransitionTime                      Reason     Message
</span><span class='line'>  ----                  ------  -----------------                       ------------------                      ------     -------
</span><span class='line'>  OutOfDisk             False   Sun, 25 Jun 2017 01:39:38 +0000         Fri, 23 Jun 2017 17:31:44 +0000         KubeletHasSufficientDisk    kubelet has sufficient disk space available
</span><span class='line'>  MemoryPressure        False   Sun, 25 Jun 2017 01:39:38 +0000         Tue, 20 Jun 2017 19:27:31 +0000         KubeletHasSufficientMemory  kubelet has sufficient memory available
</span><span class='line'>  DiskPressure          False   Sun, 25 Jun 2017 01:39:38 +0000         Tue, 20 Jun 2017 19:27:31 +0000         KubeletHasNoDiskPressure    kubelet has no disk pressure
</span><span class='line'>  Ready                 True    Sun, 25 Jun 2017 01:39:38 +0000         Fri, 23 Jun 2017 17:31:54 +0000         KubeletReady                        kubelet is posting ready status
</span><span class='line'>Addresses:              172.31.120.16,172.31.120.16,centos-minion1
</span><span class='line'>Capacity:
</span><span class='line'> alpha.kubernetes.io/nvidia-gpu:        0
</span><span class='line'> cpu:                                   1
</span><span class='line'> memory:                                1015348Ki
</span><span class='line'> pods:                                  110
</span><span class='line'>Allocatable:
</span><span class='line'> alpha.kubernetes.io/nvidia-gpu:        0
</span><span class='line'> cpu:                                   1
</span><span class='line'> memory:                                1015348Ki
</span><span class='line'> pods:                                  110
</span><span class='line'>System Info:
</span><span class='line'> Machine ID:                    f9afeb75a5a382dce8269887a67fbf58
</span><span class='line'> System UUID:                   EC2C8A0E-91D6-F54E-5A49-534A6A903FDA
</span><span class='line'> Boot ID:                       20961efd-c946-481a-97cb-7788209551ae
</span><span class='line'> Kernel Version:                3.10.0-327.28.2.el7.x86_64
</span><span class='line'> OS Image:                      CentOS Linux 7 (Core)
</span><span class='line'> Operating System:              linux
</span><span class='line'> Architecture:                  amd64
</span><span class='line'> Container Runtime Version:     docker://1.12.6
</span><span class='line'> Kubelet Version:               v1.5.2
</span><span class='line'> Kube-Proxy Version:            v1.5.2
</span><span class='line'>ExternalID:                     centos-minion1
</span><span class='line'>Non-terminated Pods:            (0 in total)
</span><span class='line'>  Namespace                     Name            CPU Requests    CPU Limits      Memory Requests Memory Limits
</span><span class='line'>  ---------                     ----            ------------    ----------      --------------- -------------
</span><span class='line'>Allocated resources:
</span><span class='line'>  (Total limits may be over 100 percent, i.e., overcommitted.
</span><span class='line'>  CPU Requests  CPU Limits      Memory Requests Memory Limits
</span><span class='line'>  ------------  ----------      --------------- -------------
</span><span class='line'>  0 (0%)        0 (0%)          0 (0%)          0 (0%)
</span><span class='line'>Events:
</span><span class='line'>  FirstSeen     LastSeen        Count   From                            SubObjectPath   Type            Reason             Message
</span><span class='line'>  ---------     --------        -----   ----                            -------------   --------        ------             -------
</span><span class='line'>  15m           15m             1       {kubelet centos-minion1}                        Normal          Starting           Starting kubelet.
</span><span class='line'>  15m           15m             1       {kubelet centos-minion1}                        Warning         ImageGCFailed      unable to find data for container /
</span><span class='line'>  15m           15m             2       {kubelet centos-minion1}                        Normal          NodeHasSufficientDisk       Node centos-minion1 status is now: NodeHasSufficientDisk
</span><span class='line'>  15m           15m             2       {kubelet centos-minion1}                        Normal          NodeHasSufficientMemory     Node centos-minion1 status is now: NodeHasSufficientMemory
</span><span class='line'>  15m           15m             2       {kubelet centos-minion1}                        Normal          NodeHasNoDiskPressure       Node centos-minion1 status is now: NodeHasNoDiskPressure
</span><span class='line'>  15m           15m             1       {kubelet centos-minion1}                        Warning         Rebooted           Node centos-minion1 has been rebooted, boot id: 20961efd-c946-481a-97cb-7788209551ae</span></code></pre></td></tr></table></div></figure>


<p><strong>O</strong>bviamente recebemos um retorno com muitas informações em formato Json, o que nem sempre é como esperamos. Existem formas de filtrar os resultados e conseguir informações mais precisas, como o bom e velho grep:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@kalib1 ~]# kubectl describe node centos-minion1 | grep Addresses
</span><span class='line'>Addresses:              172.31.120.16,172.31.120.16,centos-minion1</span></code></pre></td></tr></table></div></figure>


<p><strong>V</strong>ocê também pode utilizar expressões regulares e a sintaxe do próprio Kubernetes para consultas mais complexas, como por exemplo, formatar a minha saída Json de forma a pegar apenas a listagem de status dos meus nodes que estão com Ready = True:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@kalib1 ~]# kubectl get nodes -o jsonpath='{range .items[*]}{@.metadata.name}:{range @.status.conditions[*]}{@.type}={@.status};{end}{end}'| tr ';' "\n" | grep "Ready=True"
</span><span class='line'>
</span><span class='line'>Ready=True
</span><span class='line'>Ready=True
</span><span class='line'>Ready=True</span></code></pre></td></tr></table></div></figure>


<p><strong>A</strong> sua criatividade é o limite. ;]</p>

<p><strong>N</strong>ão temos nenhum pod configurado, mas também poderíamos utilizar <em>kubectl get</em> para conseguir a listagem de nossos pods:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@kalib1 ~]# kubectl get pods
</span><span class='line'>
</span><span class='line'>No resources found.</span></code></pre></td></tr></table></div></figure>


<h2>Criando pods</h2>

<p><strong>A</strong>ssim como com o Docker, Ansible e algumas outras ferramentas, utilizaremos a linguagem <a href="https://pt.wikipedia.org/wiki/YAML">YAML</a> para criar nossos arquivos de configuração.</p>

<p><strong>C</strong>riaremos um diretório chamado <em>Builds</em> em nosso Master Controller apenas para melhor organizar nossos arquivos de configuração e ficar mais fácil encontrá-los no futuro:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># mkdir Builds
</span><span class='line'>
</span><span class='line'># cd Builds</span></code></pre></td></tr></table></div></figure>


<p><strong>P</strong>ara criarmos Pods, o que fazemos na verdade é criar arquivos de configuração que vão dizer ao Kubernetes qual o estado em que desejamos nossa infraestrutura. O papel do Kubernetes é ler esta configuração e assegurar que o estado de nossa infraestrutura reflita o estado desejado.</p>

<p><strong>P</strong>ara facilitar, vamos utilizar exemplos encontrados na própria documentação do Kubernetes. Comecemos com a criação de um Pod para um servidor web Nginx.</p>

<p><strong>V</strong>amos criar um arquivo chamado nginx.yaml dentro do diretório Builds que criamos anteriormente:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># vim nginx.yaml</span></code></pre></td></tr></table></div></figure>


<p><strong>N</strong>o arquivo indicaremos alguns atributos ou variáveis, bem como seus respectivos valores:</p>

<ul>
<li>apiVersion &ndash; Indica a versão da API do kubernetes utilizada</li>
<li>kind &ndash; o tipo de recurso que desejamos</li>
<li>metadata &ndash; dados referentes ao recurso desejado</li>
<li>spec &ndash; especificações sobre o que este recurso irá conter</li>
</ul>


<p><strong>V</strong>amos criar um Pod contendo um único container rodando a versão 1.7.9 do nginx bem como disponibilizando a porta 80 para receber conexões. Este deverá ser o conteúdo do arquivo <em>nginx.yaml</em>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>apiVersion: v1
</span><span class='line'>kind: Pod
</span><span class='line'>metadata:
</span><span class='line'>  name: nginx
</span><span class='line'>spec:
</span><span class='line'>  containers:
</span><span class='line'>    - name: nginx
</span><span class='line'>      image: nginx:1.7.9
</span><span class='line'>      ports:
</span><span class='line'>      - containerPort: 80</span></code></pre></td></tr></table></div></figure>


<p><strong>A</strong>ntes de executarmos, vamos nos certificar novamente de duas coisas:</p>

<ul>
<li>Que realmente não temos nenhum Pod criado e ativo;</li>
<li>Que não temos nenhum container rodando em nossos nodes.</li>
</ul>


<p><em>No centos-master:</em></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@kalib1 Builds]# kubectl get pods
</span><span class='line'>
</span><span class='line'>No resources found.</span></code></pre></td></tr></table></div></figure>


<p><em>No centos-minion1: (Execute o mesmo comando nos demais nodes (centos-minion2 e centos-minion3))</em></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@kalib2 ~]# docker ps
</span><span class='line'>
</span><span class='line'>CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</span></code></pre></td></tr></table></div></figure>


<p><em>Novamente: Se você não faz ideia do que acabei de digitar, (docker ps) volte e leia um pouco sobre <a href="/blog/2015/08/20/docker-uma-alternativa-elegante-para-containers-no-linux/">Docker</a> antes de seguir com este artigo.</em></p>

<p><strong>C</strong>omo podemos ver, não temos nenhum Pod, bem como nenhum container rodando em nossos nodes.</p>

<p><strong>V</strong>amos utilizar <em>kubectl create</em> para criar o Pod utilizando o arquivo que criamos <em>nginx.yaml</em>: <em>Executaremos este comando no Master Controller &ndash; centos-master</em></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@kalib1 Builds]# kubectl create -f nginx.yaml
</span><span class='line'>
</span><span class='line'>pod "nginx" created</span></code></pre></td></tr></table></div></figure>


<p><strong>O</strong> Kubernetes está dizendo que nosso Pod &ldquo;nginx&rdquo; foi criado. Vamos verificar:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@kalib1 Builds]# kubectl get pods
</span><span class='line'>
</span><span class='line'>NAME      READY     STATUS    RESTARTS   AGE
</span><span class='line'>nginx     1/1       Running   0          1m</span></code></pre></td></tr></table></div></figure>


<p><strong>O</strong> pod está criado e rodando. Agora, execute novamente <em>docker ps</em> nos 3 nodes para identificar em qual deles o container foi criado. Sim, como não especificamos nada, o Kubernetes vai verificar os recursos disponíveis no momento e vai lançar onde ele achar mais adequado.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@kalib4 ~]# docker ps
</span><span class='line'>
</span><span class='line'>CONTAINER ID        IMAGE                                      COMMAND                  CREATED             STATUS              PORTS               NAMES
</span><span class='line'>6de8e22e1536        nginx:1.7.9                                "nginx -g 'daemon off"   2 minutes ago       Up 2 minutes                            k8s_nginx.b0df00ef_nginx_default_d4debd3a-594c-11e7-b587-06827a5b32d4_583881e0
</span><span class='line'>ae49b36ae11b        gcr.io/google_containers/pause-amd64:3.0   "/pause"                 2 minutes ago       Up 2 minutes                            k8s_POD.b2390301_nginx_default_d4debd3a-594c-11e7-b587-06827a5b32d4_fb5c834f</span></code></pre></td></tr></table></div></figure>


<p><strong>S</strong>im, existem dois containers rodando. Um deles é o nosso &ldquo;nginx&rdquo;, enquanto que o outro é um container padrão do google chamado &ldquo;/pause&rdquo;, o qual será responsável pela manutenção de alguns recursos de nosso cluster.</p>

<p><strong>P</strong>odemos novamente pedir a descrição deste pod que acabamos de criar:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@kalib1 Builds]# kubectl describe pod nginx
</span><span class='line'>
</span><span class='line'>Name:           nginx
</span><span class='line'>Namespace:      default
</span><span class='line'>Node:           centos-minion3/172.31.123.22
</span><span class='line'>Start Time:     Sun, 25 Jun 2017 02:20:18 +0000
</span><span class='line'>Labels:         &lt;none&gt;
</span><span class='line'>Status:         Running
</span><span class='line'>IP:             172.17.0.2
</span><span class='line'>Controllers:    &lt;none&gt;
</span><span class='line'>Containers:
</span><span class='line'>  nginx:
</span><span class='line'>    Container ID:               docker://6de8e22e153618271bb6e8095c68070126541331c8acfc3f5d1a654f4b978454
</span><span class='line'>    Image:                      nginx:1.7.9
</span><span class='line'>    Image ID:                   docker-pullable://docker.io/nginx@sha256:e3456c851a152494c3e4ff5fcc26f240206abac0c9d794affb40e0714846c451
</span><span class='line'>    Port:                       80/TCP
</span><span class='line'>    State:                      Running
</span><span class='line'>      Started:                  Sun, 25 Jun 2017 02:20:27 +0000
</span><span class='line'>    Ready:                      True
</span><span class='line'>    Restart Count:              0
</span><span class='line'>    Volume Mounts:              &lt;none&gt;
</span><span class='line'>    Environment Variables:      &lt;none&gt;
</span><span class='line'>Conditions:
</span><span class='line'>  Type          Status
</span><span class='line'>  Initialized   True
</span><span class='line'>  Ready         True
</span><span class='line'>  PodScheduled  True
</span><span class='line'>No volumes.
</span><span class='line'>QoS Class:      BestEffort
</span><span class='line'>Tolerations:    &lt;none&gt;
</span><span class='line'>Events:
</span><span class='line'>  FirstSeen     LastSeen        Count   From                            SubObjectPath           Type            Reason     Message
</span><span class='line'>  ---------     --------        -----   ----                            -------------           --------        ------     -------
</span><span class='line'>  6m            6m              1       {default-scheduler }                                    Normal          Scheduled  Successfully assigned nginx to centos-minion3
</span><span class='line'>  6m            6m              1       {kubelet centos-minion3}        spec.containers{nginx}  Normal          Pulling    pulling image "nginx:1.7.9"
</span><span class='line'>  6m            6m              2       {kubelet centos-minion3}                                Warning         MissingClusterDNS   kubelet does not have ClusterDNS IP configured and cannot create Pod using "ClusterFirst" policy. Falling back to DNSDefault policy.
</span><span class='line'>  6m            6m              1       {kubelet centos-minion3}        spec.containers{nginx}  Normal          Pulled     Successfully pulled image "nginx:1.7.9"
</span><span class='line'>  6m            6m              1       {kubelet centos-minion3}        spec.containers{nginx}  Normal          Created    Created container with docker id 6de8e22e1536; Security:[seccomp=unconfined]
</span><span class='line'>  6m            6m              1       {kubelet centos-minion3}        spec.containers{nginx}  Normal          Started    Started container with docker id 6de8e22e1536</span></code></pre></td></tr></table></div></figure>


<p><strong>O</strong>bviamente que isto é apenas a configuração mais básica que se possa imaginar, sem storage, mapeamentos de portas, redirecionamentos, rotas, etc. A ideia é apenas uma apresentação inicial..o que é o Kubernetes.</p>

<p><strong>H</strong>appy Hacking</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Anteriores</a>
    
    <a href="/blog/archives">Arquivos do Blog</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1 align="left">Marcelo Cavalcante</h1>
  <p><img class="right" src="http://www.marcelocavalcante.net/imgs/kalib_picture_pq_circle_pq.png" title="'kalib'" ><p align=rght>Sysadmin dinâmico, escrupulosamente curioso, reservadamente convencional, multitarefa, command line heavy-user, estudante e pesquisador, surfista por prazer, leitor inquieto e apaixonado por vinhos.<br>Me conheça melhor <a href="http://blog.marcelocavalcante.net/about">clicando aqui</a>.</p></p>
</section><section>
  <h1>Posts Recentes</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2018/04/14/chef-uso-de-condicionais-not-if-e-only-if/">Chef: Uso de Condicionais not_if e only_if</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/04/01/chef-aautomacao-e-gerenciamento-de-configuracao/">Chef: Automação e Gerenciamento de Configuração</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/06/24/conhecendo-o-kubernetes-clusters-de-containers/">Conhecendo o Kubernetes - Clusters de Containers</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/03/11/recebendo-alarmes-do-aws-diretamente-no-slack/">Recebendo Alarmes do AWS Diretamente no Slack</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/08/20/docker-uma-alternativa-elegante-para-containers-no-linux/">Docker - Uma alternativa elegante para containers no Linux</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Estou lendo</h1>
  <img align="center" src="/imgs/livros/spiritprophecy.jpg">
</section>
<section>
  <h1> Eu apoio
</h1>
  <span>
    <a href='http://ansible.com'><img style='padding: .5em; margin: .5em;' src='/images/stickers/ansible.com.png'></a><a href='http://archlinux.org'><img style='padding: .5em; margin: .5em;' src='/images/stickers/archlinux.org.png'></a><a href='http://asterisk.org'><img style='padding: .5em; margin: .5em;' src='/images/stickers/asterisk.org.png'></a><a href='http://atom.io'><img style='padding: .5em; margin: .5em;' src='/images/stickers/atom.io.png'></a><a href='http://chef.io'><img style='padding: .5em; margin: .5em;' src='/images/stickers/chef.io.png'></a><a href='http://djangoproject.com'><img style='padding: .5em; margin: .5em;' src='/images/stickers/djangoproject.com.png'></a><a href='http://docker.com'><img style='padding: .5em; margin: .5em;' src='/images/stickers/docker.com.png'></a><a href='http://github.com'><img style='padding: .5em; margin: .5em;' src='/images/stickers/github.com.png'></a><img style='padding: .5em; margin: .5em;' src='/images/stickers/glider.png' ><a href='http://jenkins.io'><img style='padding: .5em; margin: .5em;' src='/images/stickers/jenkins.io.png'></a><a href='http://kde.org'><img style='padding: .5em; margin: .5em;' src='/images/stickers/kde.org.png'></a><a href='http://kubernetes.io'><img style='padding: .5em; margin: .5em;' src='/images/stickers/kubernetes.io.png'></a><a href='http://linux.org'><img style='padding: .5em; margin: .5em;' src='/images/stickers/linux.org.png'></a><a href='http://octopress.org'><img style='padding: .5em; margin: .5em;' src='/images/stickers/octopress.org.png'></a><a href='http://opensource.org'><img style='padding: .5em; margin: .5em;' src='/images/stickers/opensource.org.png'></a><a href='http://puppet.com'><img style='padding: .5em; margin: .5em;' src='/images/stickers/puppet.com.png'></a><a href='http://python.org'><img style='padding: .5em; margin: .5em;' src='/images/stickers/python.org.png'></a><a href='http://raspberrypi.org'><img style='padding: .5em; margin: .5em;' src='/images/stickers/raspberrypi.org.png'></a><a href='http://ruby-lang.org'><img style='padding: .5em; margin: .5em;' src='/images/stickers/ruby-lang.org.png'></a><a href='http://vagrantup.com'><img style='padding: .5em; margin: .5em;' src='/images/stickers/vagrantup.com.png'></a>
  </span>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2018 - Marcelo Cavalcante Rocha - Kalib -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'marcelocavalcante';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
